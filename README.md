# Курсовая работа по предмету "Проектирование высоконагруженных систем"

## Содержание
- [1. Тема и целевая аудитория](#1-тема-и-целевая-аудитория)
- [2. Расчет нагрузки](#2-расчет-нагрузки)
- [3. Глобальная балансировка нагрузки](#3-глобальная-балансировка-нагрузки)
- [4. Локальная балансировка нагрузки](#4-локальная-балансировка-нагрузки)
- [5. Логическая схема БД](#5-логическая-схема-БД)
- [6. Физическая схема БД](#6-физическая-схема-бд)
- [8. Технологии](#8-технологии)
- [9. Обеспечение надежности](#9-обеспечение-надежности)
- [10. Схема проекта](#10-схема-проекта)
- [11. Список серверов](#11-список-серверов)
- [Список использованных источников](#список-использованных-источников)

## 1. Тема и целевая аудитория

### Тема
  **Steam** — онлайн-сервис цифрового распространения компьютерных игр и программ.

### Целевая аудитория
  - 69 миллионов ежедневных активных пользователей (DAU). [^2]
  - 132 миллиона ежемесячных активных пользователей (MAU). [^1]
  - Пик одновременных пользователей онлайн - 39.31 млн [^2]

### Топ 5 по числу пользователей стран:
  Информация взята с источника [^3]
  | Страна   | Число пользователей |
  |----------|---------------------|
  | США      | 13.7 млн           |
  | Китай    | 11.4 млн            |
  | Россия   | 9.5 млн             |
  | Бразилия | 4.9 млн             |
  | Германия | 3.6 млн             |

### Функционал
 Основной фукционал сервиса заключается в приобретении игр и обмене/продаже внутриигровых предметов

 Функционал MVP:
 - Регистрация и аутентификация
 - Список игр (магазин)
 - Корзина с добавленными играми
 - Торговая площадка
 - Библиотека игр пользователя
 - Система торгового предложения по обмену внутриигровыми предметами (trade offer)
 - Профиль пользователя

## 2. Расчет нагрузки
### Продуктовые метрики:
#### Аудитория
- 69 миллионов ежедневных активных пользователей (DAU). [^2]
- 132 миллиона ежемесячных активных пользователей (MAU). [^1]
#### Средний размер хранилища
Профиль
| Данные             | Средний размер                          |
|--------------------|-----------------------------------------|
| Аватарка           | 11 KB                                   | 
| Информация профиля | 28 байт                                 |
| Статистика игр     | 231 байт (21 байт на 1 игру)            |
| Сумма              | 11.259 KB                               |

- Информация профиля: имя (10 символов, 20 байт) + краткое описание (4 символа, 8 байт)
- Статистика игры: идентификатор игры (4 байта) + кол-во часов (4 байта) + последний запуск (13 байт)
- Согласно [^7] в среднем у пользователя 11 игр. Отсюда получаем 21 * 11 = 231 байт

Игра
| Данные                  | Средний размер                |
|-------------------------|-------------------------------|
| Шапка                   | 44 KB                         |
| Скриншот                | 3.1 MB (389 KB на 1 скриншот) |
| Информация              | 4 KB                          |
| Файлы игры              | 20 GB                         |
| Сумма                   | 20.003148 GB                  |

- Было проанализировано 1000 случайных игр из магазина Steam
- В среднем у игры 8 скриншотов. Отсюда получаем 8 * 389 KB = 3.1 MB

Игровой предмет
| Данные             | Средний размер      |
|--------------------|---------------------|
| Идентификатор игры | 4 байта             |
| Картинка           | 38 KB               |
| Название           | 40 байт             |
| Описание           | 238 байт            |
| Сумма              | 38.282 KB           |

- Каждый символ весит 2 байта.

#### Среднее количество действий пользователя
| Действие                                             | Среднее число в день |
|------------------------------------------------------|----------------------|
| Регистрация/Аутентификация                           | 0.03                 |
| Просмотр игры                                        | 1.72                 |
| Покупка игры                                         | 0.005                |
| Скачивание игры                                      | 1.57                 |
| Обновление счетчика игры                             | 9                    |
| Совершение торгового обмена                          | 0.029                |
| Выставление предмета на продажу на торговой площадке | 0.0007               |
| Просмотр предмета на торговой площадке               | 0.007                |
| Покупка предмета на торговой площадке                | 0.00035              |
| Просмотр профиля                                     | 0.295                |
| Обновление профиля                                   | 0.03                 |
| Просмотр предметов                                   | 0.18                 |
| Отзыв об игре                                        | 0.00017              |

- Пользователь авторизуется в Steam в среднем раз в месяц. Тогда в день: 1 / 30 = 0.03
- Продано игр за год: 132М [^5] => За день: 132M / 365 = 361643 => один пользователь в среднем за день покупает: 361643 / 69M = 0.005
- Расчитаем число просмотров игры:
  - Согласно [^9] средняя конверсия: от 2 до 4%. Возьмем среднее: 3%. То есть для одной покупки необходимо: 1 / 0.03 = 33 посещения.
  - Предположим, что пользователь просматривает в среднем 10 страниц с играми. Тогда: 33 * 10 = 330 посещений.
  - Тогда общее число просмотров в день: 361643 * 330 = 119М
  - Тогда на одного пользователя: 119M / 69M = 1.72
- Учитывая что в среднем у пользователя 11 игр [^7] и предположив, что игры обновляются раз в неделю, то в день на 1 пользователя получим: 11 / 7 = 1.57
- Созданных торговых предложений за месяц: 58M [^4] => За день 58M / 30 = 2M => один пользователь в среднем создает торговых обменов: 2M / 69M = 0.029
- За период 1 января 2024 - 1 января 2025 согласно [^8] выставлялось 18.9М предметов => за день: 18.9M / 365 = 51780 => один пользователь в среднем выставляет на продажу: 0.0007
- За период 1 января 2024 - 1 января 2025 согласно [^8] в среднем было 172М посещений => за день: 172М / 365 = 471232 => один пользователь в среднем смотрит предметы: 0.007
- Зная метрику просмотров предмета на торговой площадке и метрику выставления предмета на продажу на торговой площадке, оценим метирку покупок. Предположим, что конверсия 5% (т.е. 1 из 20 предметов покупают). Тогда: 0.007 / 20 = 0.00035
- Чтобы обновить профиль, его надо открыть. Также следует учитывать что перед совершением обмена также будет смотреться профиль пользователя. Предположим, что каждое такое действие порождает в среднем 5 просмотров профилей. Тогда получим: (0.03 + 0.029) * 5 = 0.295
- Пользователь обновляет данные профиля в среднем раз в месяц. Тогда в день: 1 / 30 = 0.03
- Чтобы выставить предмет на продажу или совершить обмен, необходимо посмотреть инвентарь с предметами. Предположим что каждое такое действие порождает в среднем 5 просмотров инвентаря. Тогда получим: (0.029 + 0.007) * 5 = 0.18
- Согласно [^12] на 1 отзыв приходится ~30 продаж. Тогда зная метрику покупки игры получим: 0.005 / 30 = 0.00017
- Пусть 1 игровая сессия длится в среднем 1.5 часа. Интервал обновления - 10 минут. Тогда: 1.5 часа / 10 минут = 9

### Технические метрики
#### Размер хранения
| Тип данных      | Размер для одного | Количество | Размер для всех |
|-----------------|-------------------|------------|-----------------|
| Пользователь    | 11.259 KB         | 982М       | 11 TB           |
| Игра            | 20.003148 GB      | 114662     | 2.3 PB          |
| Игровой предмет | 38.282 KB         | 28M        | 1.0719 TB       |

- Согласно [^10] на момент 2020 года в Steam было зарегистрировано 667М аккаунтов. Согласно [^7] в 2017 году прирост пользователей был 63М. Тогда к 2025 получим: 667М + 63М * 5 = 982М.
  - Тогда: 11.259 KB * 982M = 11 TB
- Согласно [^6] в Steam на данный момент 114662 игр. Тогда: 20.003148 GB * 114662 = 2.3 PB
- Согласно [^8] в Steam на торговой площадке выставлено на продажу 28М игровых предметов. Тогда: 38.282 KB * 28M = 1.0719 TB

#### Сетевой трафик
RPS
- Для расчета воспользуемся таблицей с действиями пользователя и формула: (количество запросов в день от одного пользователя * DAU) / 86400
- Пиковый RPS возьмем в 3 раза выше среднего (согласно [^11]). В нашем сервисе пользователи расположены в разных часовых поясах, потому пиковая нагрузка будет не настолько резко большой.

| Действие                                             | RPS                | RPS в пике        |
|------------------------------------------------------|--------------------|-------------------|
| Регистрация/Аутентификация                           | 24                 | 72                |
| Просмотр игры                                        | 1374               | 4122              |
| Покупка игры                                         | 4                  | 12                |
| Скачивание игры                                      | 1254               | 3762              |
| Обновление счетчика игры                             | 7187.5             | 21562.5           |
| Совершение торгового обмена                          | 23.16              | 69.48             |
| Выставление предмета на продажу на торговой площадке | 0.55               | 1.65              |
| Просмотр предмета на торговой площадке               | 5.6                | 16.8              |
| Покупка предмета на торговой площадке                | 0.28               | 0.84              |
| Просмотр профиля                                     | 235.6              | 706.8             |
| Обновление профиля                                   | 24                 | 72                |
| Просмотр предметов                                   | 144                | 432               |
| Отзыв об игре                                        | 0.135              | 0.405             |

Общая нагрузка
- Формула для средней нагрузки: трафик * RPS
- Пиковую нагрузку возьмем в 3 раза выше средней

| Действие                                             | Трафик на действие (request + response) | Средняя нагрузка (Гбит/с) | Пиковая нагрузка (Гбит/с) |
|------------------------------------------------------|-----------------------------------------|---------------------------|---------------------------|
| Аутентификация                                       | 1 KB (888 байт + 174 байт)              | 0.000192                  | 0.000576                  |
| Просмотр игры                                        | 5.808 MB (2.66 KB + 3.148 MB)           | 63.8415                   | 191.5245                  |
| Покупка игры                                         | 449 байт (286 байт + 163 байт)          | 0.000014                  | 0.000042                  |
| Скачивание игры                                      | 20 GB                                   | 200640                    | 601920                    |
| Совершение торгового обмена                          | 2.719 KB (2.61 KB + 109 байт)           | 0.0005                    | 0.0015                    |
| Обновление счетчика игры                             | 1 KB                                    | 0.000192                  | 0.000576                  |
| Выставление предмета на продажу на торговой площадке | 2.256 KB (2.15 KB + 106 байт)           | 0.00001                   | 0.00003                   |
| Просмотр предмета на торговой площадке               | 42.11 KB (2.11 KB + 40 KB)              | 0.0019                    | 0.0057                    |
| Покупка предмета на торговой площадке                | 2.24 KB (2.23 KB + 151 байт)            | 0.000005                  | 0.000015                  |
| Просмотр профиля                                     | 13.37 KB (2.11 KB + 11.259 KB)          | 0.0252                    | 0.0756                    |
| Обновление профиля                                   | 4.4 KB (4.36 KB + 45 байт)              | 0.0008                    | 0.0024                    |
| Просмотр предметов                                   | 0.96 MB (2.11 KB + 38.282 KB * 25)      | 1.1059                    | 3.3177                    |
| Отзыв об игре                                        | 2.22 KB (2.21 KB + 33 байт)             | 0.0000024                 | 0.0000072                 |

- На одной странице с предметами 25 игровых предметов

## 3. Глобальная балансировка нагрузки
### Разбиение по доменам
В рамках нашего MVP будем использовать поддомены:
- game.steam.com - для скачивания игр
- community.steam.com - для взаимодействия с системами комьюнити (обмен/продажа предметов, профили, покупка игр, ...)

### Расположение ДЦ
На основе информации об использовании трафика [^11]:  
<img width="616" height="556" alt="image" src="https://github.com/user-attachments/assets/a618bda7-cd2a-40c7-8e1c-efd9e0cb1b6b" />  
а также карт [^11]:  
<img width="908" height="454" alt="image" src="https://github.com/user-attachments/assets/e760ddfc-00cd-42c8-80a9-acbea9e55010" />  
<img width="907" height="461" alt="image" src="https://github.com/user-attachments/assets/7e41bfb4-fd2f-4179-8ad0-5bbe6187b9ea" />  
расположим ДЦ следующим образом (регионы расположены от наиболее нагруженных к менее нагруженным).  
  
Скачивание игр является несложной операцией, датацентры выберем следующим образом:
- Азия: Пекин (Китай), Токио (Япония)
- Европа: Франкфурт (Германия)
- Северная Америка: Сан Хосе (Калифорния)
  
Для прочего функционала:
- Азия: Пекин (Китай), Токио (Япония)
- Европа: Франкфурт (Германия)
- Северная Америка: Сан Хосе (Калифорния)

Карта расположенных ДЦ:  
<img width="965" height="538" alt="image" src="https://github.com/user-attachments/assets/bfda6615-eee7-44ec-9f90-cb9e353dfe3e" />

### Расчет распределения запросов
Согласно [^11], общий трафик:
| Регион           | Использовано трафика всего (Tbps) |
|------------------|-----------------------------------|
| Азия             | 13.6                              |
| Европа           | 12.8                              |
| Северная Америка | 8.8                               |
| Ближний Восток   | 1.1                               |
| Океания          | 0.83                              |
| Южная Америка    | 3.1                               |

Пусть Ближний Восток будет равномерно распределятся между европейским и азиатским регионами, Океания будет использовать азиатский регион, а Южная Америка северо-американский регион. Тогда получим:
| Регион           | Использовано трафика всего (Tbps) |
|------------------|-----------------------------------|
| Азия             | 14.98                             |
| Европа           | 13.35                             |
| Северная Америка | 11.9                              |

Скачивание игр занимает большую часть трафика (~98%), согласно посчитанной ранее нагрузке.  
Тогда согласно [^11], а также выбранным ранее датацентрам для скачивания:
| Регион           | Использовано трафика (Tbps)       | Число датацентров | Трафик на 1 датацентр (Tbps) |
|------------------|-----------------------------------|-------------------|------------------------------|
| Азия             | 14.6804                           | 2                 | 7.3402                       |
| Европа           | 13.083                            | 1                 | 13.083                       |
| Северная Америка | 11.662                            | 1                 | 11.662                       |

Для остального трафика:
| Регион           | Использовано трафика (Tbps)       | Число датацентров | Трафик на 1 датацентр (Tbps) |
|------------------|-----------------------------------|-------------------|------------------------------|
| Азия             | 0.2996                            | 2                 | 0.1498                       |
| Европа           | 0.26166                           | 1                 | 0.26166                      |
| Северная Америка | 0.23324                           | 1                 | 0.23324                      |

Переводя в процентное соотношение регионы по формуле: (трафик региона / общий трафик) * 100%:
| Регион           | Процентная доля трафика     |
|------------------|-----------------------------|
| Азия             | 37.24                       |
| Европа           | 33.2                        |
| Северная Америка | 29.6                        |

Посчитаем RPS считать по формуле: (RPS на действие) * (% трафика региона)
| Действие                                             | Азия      | Европа  | Северная Америка |
|------------------------------------------------------|-----------|---------|------------------|
| Скачивание игры                                      | 1400.97   | 1249    | 1113.55          |
| Остальной функционал                                 | 10080.295 | 8986.75 | 6382.5           |

Посчитаем RPS по датацентрам: (RPS из региона) / кол-во датацентров  
Для скачивания игр:  
| Регион           | RPS     | Число датацентров | RPS на 1 датацентр |
|------------------|---------|-------------------|--------------------|
| Азия             | 1400.97 | 2                 | 700.485            |
| Европа           | 1249    | 1                 | 1249               |
| Северная Америка | 1113.55 | 1                 | 1113.55            |

Для прочего функционала:  
| Регион           | RPS       | Число датацентров | RPS на 1 датацентр |
|------------------|-----------|-------------------|--------------------|
| Азия             | 10080.295 | 2                 | 5040.1475          |
| Европа           | 8986.75   | 1                 | 8986.75            |
| Северная Америка | 6382.5    | 1                 | 6382.5             |

### Схема DNS балансировки
Будем использовать Geo-based DNS, т.к. сервисом пользуются по всему миру.

## 4. Локальная балансировка нагрузки

### L4 балансировка
L4 балансировка не требуется, т.к. L7 балансировка более чем справится с полученным пиковым RPS.

### L7 балансировка
Будем использовать Nginx (2 сервера). Один активен, другой нет. Если первый сервер упадет, второй войдет в работу (можно реализовать при помощи keepalived по VRRP)
В качестве балансировки используется алгоритм Weighted Round-Robin, чтобы равномерно распределить нагрузку. Будем кэшировать статический контент. Дополнительно можно сжимать трафик (gzip)
Дополнительно развернем в каждом датацентре кластер Kubernetes для автоматического контроля, перезапуска упавших узлов, а также возможности легкого горизонтального масштабирования. Для отслеживания состояния приложения будем использовать health-check запросы.

### Межсервисное взаимодействие
При взаимодействии одного микросервиса внутри Kubernetes с другим происходит следующий процесс:  
- Обращение к Ingress-контроллеру
- Ingress-контроллер берет домен микросервиса, к которому нужно обратиться и просит у нужного service IP-адрес пода, куда нужно перенаправить трафик.
<img width="1319" height="854" alt="image" src="https://github.com/user-attachments/assets/b4405539-d66c-4e53-a015-7c916e0b8e96" />

### Терминация SSL
Будет происходить на L7 уровне в Nginx. Дополнительно будем использовать session ticket.

## 5. Логическая схема БД
Схема представлена на скриншоте ниже  
<img width="1959" height="1461" alt="steam logic" src="https://github.com/user-attachments/assets/6578b55a-61bc-4040-9693-ba740cd83505" />

### Описание таблиц
| Таблица         | Описание |
|-----------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| User            | Данные о пользователях: id пользователя, логин (username), email, хеш пароля, имя профиля, описание профиля, URL аватарки (из CDN), дата создания (created_at), дата изменения (updated_at)                                                                               |
| UserSession     | Данные о сессиях пользователя: id сессии, id пользователя, токен, дата истечения, дата создания (created_at), дата изменения (updated_at)                                                                                                                                  |
| Currency        | Данные о валютах: id валюты, короткое наименование, полное наименование, курс к USD, дата создания (created_at), дата изменения (updated_at)                                                                                                                              |
| UserWallet      | Данные о кошельках пользователей: id кошелька, id пользователя, id валюты, баланс, дата создания (created_at), дата изменения (updated_at)                                                                                                                                |
| Developer       | Данные о разработчиках игр: id разработчика, имя, описание, дата создания (created_at), дата изменения (updated_at)                                                                                                                                                       |
| Game            | Данные об играх: id игры, id разработчика, название, описание, URL шапки (из CDN), дата выпуска, дата создания (created_at), дата изменения (updated_at)                                                                                                                  |
| GamePrice       | Данные о ценах игры: id, id игры, id валюты, цена, дата создания (created_at), дата изменения (updated_at)                                                                                                                                                                |
| GameScreenshot  | Данные о скриншотах игры: id, id игры, URL скриншота (из CDN), дата создания (created_at), дата изменения (updated_at)                                                                                                                                                    |
| UserLibrary     | Данные об играх пользователя в библиотеке: id игры, id пользователя, кол-во часов, время последнего запуска, дата создания (created_at), дата изменения (updated_at)                                                                                                      |
| Item            | Данные о предметах игры: id, id игры, название, описание, картинка предмета (из CDN), дата создания (created_at), дата изменения (updated_at)                                                                                                                             |
| UserInventory   | Данные об инвентаре пользователя: id, id предмета, id пользователя, статус предмета (доступен/выставлен на торговой площадке/находится в обмене), продаваемый ли (is_marketable), передаваемый ли (is_tradeable), дата создания (created_at), дата изменения (updated_at) |
| MarketListing   | Данные о выставленных предметах на продажу: id, id предмета в инвентаре, цена в USD, дата создания (created_at), дата изменения (updated_at)                                                                                                                              |
| GameReview      | Данные об отзывах к игре: id, id пользователя, id игры, положительный ли (is_positive), текст отзыва, дата создания (created_at), дата изменения (updated_at)                                                                                                             |
| TradeOffer      | Данные о торговых предложениях: id, от пользователя (from_user_id), для пользователя (to_user_id), статус (ожидание/принят/отклонен), дата создания (created_at), дата изменения (updated_at)                                                                             |
| TradeOfferItem  | Данные о предметах в торговом предложении: id торгового предложения, id предмета из инвентаря, дата создания (created_at), дата изменения (updated_at)                                                                                                                    |

### Размеры данных
| Таблица         | Расчет размера строки                                                                                                                                                   | Размер строки | Всего строк | Размер таблицы |
|-----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------|-------------|----------------|
| User            | 8 (id) + 16 (username) + 32 (email) + 16 (password_hash) + 32 (profile_name) + 128 байт (profile_description) + 128 байт (avatar_url) + 1 (is_deleted) + 8 (created_at) + 8 (updated_at) | 377 байт      | 982М        | 370.21 GB      |
| UserSession     | 8 (id) + 8 (user_id) + 32 (token) + 8 (expires_at) +  8 (created_at) + 8 (updated_at)                                                                                   | 72 байт       | 1.964 млрд  | 141.41 GB      |
| Currency        | 4 (id) + 4 (short_name) + 16 (display_name) + 4 (usd_currency) + 8 (created_at) + 8 (updated_at)                                                                        | 44 байт       | 47 [^13]    | 2.068 KB       |
| UserWallet      | 8 (id) + 8 (user_id) + 4 (currency_id) + 4 (balance) + 8 (created_at) + 8 (updated_at)                                                                                  | 40 байт       | 982М        | 39.28 GB       |
| Developer       | 4 (id) + 16 (name) + 128 (description) + 8 (created_at) + 8 (updated_at)                                                                                                | 164 байт      | 44000 [^14] | 7.216 MB       |
| Game            | 4 (id) + 4 (developer_id) + 16 (title) + 128 (description) + 128 (header_image_url) + 8 (release_date) + 1 (is_deleted) + 8 (created_at) + 8 (updated_at)                                | 305 байт      | 114662      | 34.9719 MB     |
| GamePrice       | 8 (id) + 4 (game_id) + 4 (currency_id) + 4 (price) + 8 (created_at) + 8 (updated_at)                                                                                    | 36 байт       | 5.4M        | 194.4 MB       |
| GameScreenshot  | 8 (id) + 4 (game_id) + 128 (screenshot_url) + 8 (created_at) + 8 (updated_at)                                                                                           | 156 байт      | 917296      | 143.1 MB       |
| UserLibrary     | 4 (game_id) + 8 (user_id) + 4 (playtime_hours) + 8 (last_played_at) + 8 (created_at) + 8 (updated_at)                                                                   | 40 байт       | 10.8 млрд   | 432 GB         |
| Item            | 8 (id) + 4 (game_id) + 16 (name) + 128 (description) + 128 (image_url) + 1 (is_deleted) + 8 (created_at) + 8 (updated_at)                                                                | 301 байт      | 5М          | 1.505 GB         |
| UserInventory   | 8 (id) + 8 (item_id) + 8 (user_id) + 8 (status) + 1 (is_tradeable) + 1 (is_marketable) + 8 (created_at) + 8 (updated_at)                                                | 50 байт       | 56M         | 2.8 GB         |
| MarketListing   | 8 (id) + 8 (inventory_item_id) + 4 (price) + 8 (created_at) + 8 (updated_at)                                                                                            | 36 байт       | 28M         | 1.008 GB       |
| GameReview      | 8 (id) + 8 (user_id) + 4 (game_id) + 1 (is_positive) + 256 (text) + 8 (created_at) + 8 (updated_at)                                                                     | 293 байт      | 43.3M [^15] | 12.6869 GB     |
| TradeOffer      | 8 (id) + 8 (from_user_id) + 8 (to_user_id) + 8 (status) + 8 (created_at) + 8 (updated_at)                                                                               | 48 байт       | 7.59 млрд   | 364.32 GB      |
| TradeOfferItem  | 8 (inventory_item_id) + 8 (trade_offer_id) + 8 (created_at) + 8 (updated_at)                                                                                            | 32 байт       | 37.95 млрд  | 1.2144 TB      |

### Требования к консинстентности
1. При удалении пользователя, данные в связанных таблицах удаляются (сессии, отзывы, предметы, отмена торговых предложений/лотов и тд)
2. При удалении игры, данные в связаннх таблицах удаляются (предметы игры, отзывы, и тд)
3. При удалении предмета, данные в связанных таблицах удаляются (торговый обмен, лот, инвентарь)
4. При удалении валюты, данные в связанных таблицах удаляются (цена игры), тип кошелька пользователей меняется на доступный
5. Нельзя обменять или выставить предмет на продажу, который либо уже задействован в какой-то операции, либо данная опция в предмете заблокирована
6. Операции с кошельком должны быть в формате транзакции, чтобы не потерять согласованное состояние

### Нагрузка на чтение и запись
| Действие                                             | RPS                | RPS в пике        | Запросы БД                                                                                                 | Средний QPS (Чтение) | Пиковый QPS (Чтение) | Средний QPS (Запись) | Пиковый QPS (Запись) |
|------------------------------------------------------|--------------------|-------------------|------------------------------------------------------------------------------------------------------------|----------------------|----------------------|----------------------|----------------------|
| Регистрация/Аутентификация                           | 24                 | 72                | 2-4 (select User, insert UserSession, insert UserWallet, insert User)                                                   | 24                   | 72                   | 72                   | 216                  |
| Просмотр игры                                        | 1374               | 4122              | 5 (select Game, select Developer, select GameScreenshot, select GamePrice, select GameReview)              | 6870                 | 20610                | 0                    | 0                    |
| Покупка игры                                         | 4                  | 12                | 3 (select UserWallet, update UserWallet, insert UserLibrary)                                               | 4                    | 12                   | 8                    | 24                   |
| Скачивание игры                                      | 1254               | 3762              | 1 (select UserLibrary)                                                                                     | 1254                 | 3762                 | 0                    | 0                    |
| Обновление счетчика игры                             | 7187.5             | 21562.5           | 1 (update UserLibrary)                                                                                     | 0                    | 0                    | 7187.5                    | 21562.5                    |
| Совершение торгового обмена                          | 23.16              | 69.48             | 4 (select UserInventory, insert TradeOffer, insert TradeOfferItem, update UserInventory)                   | 23.16                | 69.48                | 69.48                | 208.44               |
| Выставление предмета на продажу на торговой площадке | 0.55               | 1.65              | 3 (select UserInventory, update UserInventory, insert MarketListing)                                       | 0.55                 | 1.65                 | 0.55                 | 1.65                 |
| Просмотр предмета на торговой площадке               | 5.6                | 16.8              | 2 (select MarketListing, select Item)                                                                      | 11.2                 | 33.6                 | 0                    | 0                    |
| Покупка предмета на торговой площадке                | 0.28               | 0.84              | 5 (select UserWallet, select MarketListing, update UserWallet, update UserInventory, delete MarketListing) | 0.56                 | 1.68                 | 0.84                 | 2.52                 |
| Просмотр профиля                                     | 235.6              | 706.8             | 3 (select User, select UserInventory, select UserLibrary)                                                  | 706.8                | 2120.4               | 0                    | 0                    |
| Обновление профиля                                   | 24                 | 72                | 1 (update User)                                                                                            | 0                    | 0                    | 24                   | 72                   |
| Просмотр предметов                                   | 144                | 432               | 3 (select User, select UserInventory, select Item)                                                         | 432                  | 1296                 | 0                    | 0                    |
| Отзыв об игре                                        | 0.135              | 0.405             | 1 (insert GameReview)                                                                                      | 0                    | 0                    | 0.135                | 0.405                |

## 6. Физическая схема БД
Схема представлена на скриноте ниже  
<img width="2411" height="1691" alt="image" src="https://github.com/user-attachments/assets/12a2bc36-f635-436b-9dbe-abf3f9d92b1e" />  
В TradeOffer в item_details лежит JSON, где item_details предмет с полями:
- inventory_item_id bigint - ID предмета в инвентаре
- item_id bigint - название предмета
- item_description text - описание пердмета
- item_image_url varchar - URL картинки предмета  

### Денормализация
- UserWallet удален, информация о валюте и балансе внесена в User для избежания JOIN
- В User добавлены поля games_count, inventory_items_count, reviews_given_count для избежания операций COUNT
- Таблица Currency сохранена. Она очень незначительна по размеру и ей можно принебречь. Предполагается что она будет единожды подгружаться приложением при инициализации и сохраняться в ОЗУ.
- Таблица GameScreenshots удалена. Скриншоты будут храниться в JSON формате в Game
- Добавлена таблица GameDetails. В нее вынесена вся информация об игре, разработчике, числе отзывов, скриншотах. Она будет использоваться при запросе просмотра игры. Таблица Game и связанные с ней будут в панели разработчика.
- В UserLibrary добавлены поля game_title и game_header_image_url для избежания JOIN
- В UserInventory добавлены поля game_id, game_title, item_name, item_description, item_image_url для избежания JOIN
- В MarketListing добавлены поля game_id, game_title, item_name, item_description, item_image_url, seller_user_id, seller_profile_name для избежания JOIN
- В TradeOffer добавлены поля from_user_name, to_user_name для избежания JOIN
- TradeOfferItem удален. Его поля вынесены в TradeOffer для избежания JOIN (подробнее описано выше). Каждый item хранится в TradeOffer отдельной сущностью. Для дальнейшего удобного шардирования введено owner_user_id, partner_user_id и is_outgoing

#### Размеры после денормализации
| Таблица         | Расчет размера строки                                                                                                                                                   | Размер строки | Всего строк | Размер таблицы |
|-----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------|-------------|----------------|
| User            | 8 (id) + 16 (username) + 32 (email) + 16 (password_hash) + 32 (profile_name) + 128 (profile_description) + 128 (avatar_url) + 1 (is_deleted) + 4 (currency_id) + 4 (balance) + 4 (games_count) + 4 (inventory_items_count) + 4 (reviews_given_count) + 8 (created_at) + 8 (updated_at) | 397 байт      | 982М        | 389.85 GB      |
| UserSession     | 8 (id) + 8 (user_id) + 32 (token) + 8 (expires_at) +  8 (created_at) + 8 (updated_at)                                                                                   | 72 байт       | 1.964 млрд  | 141.41 GB      |
| Currency        | 4 (id) + 4 (short_name) + 16 (display_name) + 4 (usd_currency) + 8 (created_at) + 8 (updated_at)                                                                        | 44 байт       | 47 [^13]    | 2.068 KB       |
| Developer       | 4 (id) + 16 (name) + 128 (description) + 8 (created_at) + 8 (updated_at)                                                                                                | 164 байт      | 44000 [^14] | 7.216 MB       |
| Game            | 4 (id) + 4 (developer_id) + 16 (title) + 128 (description) + 128 (header_image_url) + 8 (release_date) + 1024 (screenshots) + 1 (is_deleted) + 8 (created_at) + 8 (updated_at)                                | 1329 байт      | 114662      | 152.39 MB     |
| GameDetails     | 4 (game_id) + 16 (title) + 128 (description) + 128 (header_image_url) + 8 (release_date) + 1024 (screenshots) + 1 (is_deleted) + 4 (developer_id) + 16 (developer_name) + 4 (reviews_total_count) + 4 (reviews_positive_count) + 8 (created_at) + 8 (updated_at) | 1353 байт | 114662 | 155.14 MB
| GamePrice       | 8 (id) + 4 (game_id) + 4 (currency_id) + 4 (price) + 8 (created_at) + 8 (updated_at)                                                                                    | 36 байт       | 5.4M        | 194.4 MB       |
| UserLibrary     | 4 (game_id) + 8 (user_id) + 16 (game_title) + 4 (playtime_hours) + 8 (last_played_at) + 8 (created_at) + 8 (updated_at)                                                                   | 56 байт       | 10.8 млрд   | 604.8 GB         |
| Item            | 8 (id) + 4 (game_id) + 16 (name) + 128 (description) + 128 (image_url) + 8 (created_at) + 8 (updated_at)                                                                | 300 байт      | 5М          | 1.5 GB         |
| UserInventory   | 8 (id) + 8 (item_id) + 8 (user_id) + 8 (status) + 4 (game_id) + 8 (game_title) + 16 (item_name) + 128 (item_description) + 128 (item_image_url) + 1 (is_tradeable) + 1 (is_marketable) + 8 (created_at) + 8 (updated_at)                                                | 334 байт       | 56M         | 18.704 GB         |
| MarketListing   | 8 (id) + 8 (inventory_item_id) + 4 (price) + 8 (seller_user_id) + 16 (seller_profile_name) + 4 (game_id) + 16 (game_title) + 16 (item_name) + 128 (item_description) + 128 (item_image_url) + 8 (created_at) + 8 (updated_at)                                                                                            | 352 байт       | 28M         | 9.856 GB       |
| GameReview      | 8 (id) + 8 (user_id) + 4 (game_id) + 1 (is_positive) + 256 (text) + 8 (created_at) + 8 (updated_at)                                                                     | 293 байт      | 43.3M [^15] | 12.6869 GB     |
| TradeOffer      | 8 (id) + 8 (owner_user_id) + 8 (partner_user_id) + 1 (is_outgoing) + 16 (from_user_name) + 16 (to_user_name) + 16 (item_name) + 272 (item_details) + 8 (item_owner_id) + 8 (status) + 8 (created_at) + 8 (updated_at)                                                                               | 377 байт       | 75.9 млрд   | 28.614 TB |

Полагаем, что в среднем в 1 торговом предложении 5 обменов

#### Нагрузка на чтение и запись после денормализации
| Действие                                             | RPS                | RPS в пике        | Запросы БД                                                                                                 | Средний QPS (Чтение) | Пиковый QPS (Чтение) | Средний QPS (Запись) | Пиковый QPS (Запись) |
|------------------------------------------------------|--------------------|-------------------|------------------------------------------------------------------------------------------------------------|----------------------|----------------------|----------------------|----------------------|
| Регистрация/Аутентификация                           | 24                 | 72                | 2-3 (select User, insert UserSession, insert User)                                                   | 24                   | 72                   | 48                   | 144                  |
| Просмотр игры                                        | 1374               | 4122              | 2 (select GameDetails, select GamePrice)              | 2748                 | 8244                | 0                    | 0                    |
| Покупка игры                                         | 4                  | 12                | 3 (select User, update User, insert UserLibrary)                                               | 4                    | 12                   | 8                    | 24                   |
| Скачивание игры                                      | 1254               | 3762              | 1 (select UserLibrary)                                                                                     | 1254                 | 3762                 | 0                    | 0                    |
| Обновление счетчика игры                             | 7187.5             | 21562.5           | 1 (update UserLibrary)                                                                                     | 0                    | 0                    | 7187.5                    | 21562.5                    |
| Совершение торгового обмена                          | 23.16              | 69.48             | 3 (select UserInventory, insert TradeOffer, update UserInventory)                   | 23.16                | 69.48                | 46.32                | 138.96               |
| Выставление предмета на продажу на торговой площадке | 0.55               | 1.65              | 3 (select UserInventory, update UserInventory, insert MarketListing)                                       | 0.55                 | 1.65                 | 0.55                 | 1.65                 |
| Просмотр предмета на торговой площадке               | 5.6                | 16.8              | 1 (select MarketListing)                                                                      | 5.6                 | 16.8                 | 0                    | 0                    |
| Покупка предмета на торговой площадке                | 0.28               | 0.84              | 5 (select User, select MarketListing, update User, update UserInventory, delete MarketListing) | 0.56                 | 1.68                 | 0.84                 | 2.52                 |
| Просмотр профиля                                     | 235.6              | 706.8             | 3 (select User, select UserInventory, select UserLibrary)                                                  | 706.8                | 2120.4               | 0                    | 0                    |
| Обновление профиля                                   | 24                 | 72                | 1 (update User)                                                                                            | 0                    | 0                    | 24                   | 72                   |
| Просмотр предметов                                   | 144                | 432               | 1 (select UserInventory)                                                         | 144                  | 432                 | 0                    | 0                    |
| Отзыв об игре                                        | 0.135              | 0.405             | 1 (insert GameReview, update GameDetails, update User)                                                                                      | 0                    | 0                    | 0.405                | 1.215                |

### Индексы
| Таблица       | Индекс                                                                           | Тип индекса     | Размер одной строки | Всего строк | Итоговый размер | Пояснение                                            |
|---------------|----------------------------------------------------------------------------------|-----------------|---------------------|-------------|-----------------|------------------------------------------------------|
| User          | idx_user_id (id)                                                                 | B-Tree          | 8 байт              | 982M        | 7.856 GB        | Доступ по ID                                         |
| User          | idx_user_username (username)                                                     | Hash            | 16 байт             | 982M        | 15.712 GB       | Быстрый поиск при входе в систему                    |
| User          | idx_user_email (email)                                                           | Hash            | 32 байта            | 982M        | 31.424 GB       | Быстрый поиск при регистрация/сбросе пароля          |
| UserSession   | idx_session_id (id)                                                              | B-Tree          | 8 байт              | 1.964 млрд  | 15.712 GB       | Уникальный идентификатор сессии                      |
| UserSession   | idx_session_token (token)                                                        | Hash            | 32 байт             | 1.964 млрд  | 62.848 GB       | Поиск сессии по токену                               |
| UserSession   | idx_session_user_id (user_id)                                                    | Hash            | 8 байт              | 1.964 млрд  | 15.712 GB       | Поиск всех активных сессий пользователя              |
| Currency      | idx_currency_id (id)                                                             | B-Tree          | 4 байт              | 47          | 188 байт        | Доступ по ID                                         |
| Developer     | idx_developer_id (id)                                                            | B-Tree          | 4 байт              | 44000       | 176 KB          | Доступ по ID                                         |
| Game          | idx_game_id (id)                                                                 | B-Tree          | 4 байт              | 114662      | 458.65 KB       | Доступ по ID                                         |
| Game          | idx_game_developer_id (id)                                                       | Hash            | 4 байт              | 114662      | 458.65 KB       | Поиск игр разработчика                               |
| GameDetails   | idx_game_details_id (game_id)                                                    | B-Tree          | 4 байт              | 114662      | 458.65 KB       | Доступо по ID                                        |
| GamePrice     | idx_game_price_id (id)                                                           | B-Tree          | 8 байт              | 5.4М        | 43.2 MB         | Доступ по ID                                         |
| GamePrice     | idx_game_price_game_currency (game_id, currency_id)                              | B-Tree          | 8 байт              | 5.4М        | 43.2 MB         | Поиск цены для игры и валюты                         |
| UserLibrary   | idx_user_library_user_game_id (user_id, game_id)                                 | B-Tree          | 12 байт             | 10.8 млрд   | 129.6 GB        | Быстрый поиск игры в библиотеке пользовател          |
| UserLibrary   | idx_user_library_user_game_id (user_id, last_played_at)                          | B-Tree          | 16 байт             | 10.8 млрд   | 172.8 GB        | Недавно-запущенные игры                              |
| Item          | idx_item_id (id)                                                                 | B-Tree          | 8 байт              | 5М          | 40 MB           | Доступ по ID                                         |
| Item          | idx_item_game_id (game_id)                                                       | Hash            | 8 байт              | 5М          | 40 MB           | Поиск предметов в конкретной игре                    |
| UserInventory | idx_user_inventory_id (id)                                                       | B-Tree          | 8 байт              | 56М         | 448 MB          | Доступ по ID                                         |
| UserInventory | idx_user_inventory_user_game_id (user_id, game_id)                               | B-Tree          | 12 байт             | 56М         | 672 MB          | Инвентарь пользователя по игре                       |
| MarketListing | idx_market_listing_id (id)                                                       | B-Tree          | 8 байт              | 28М         | 224 MB          | Доступ по ID                                         |
| MarketListing | idx_market_listing_id (item_name, game_id, price)                                | B-Tree          | 24 байт             | 28М         | 672 MB          | Поиск по предмету, игре с сортировкой по цене        |
| MarketListing | idx_market_listing_id (seller_user_id)                                           | Hash            | 8 байт              | 28М         | 224 MB          | Просмотр лотов продавца                              |
| GameReview    | idx_game_review_id (id)                                                          | B-Tree          | 8 байт              | 43.3M       | 346.4 MB        | Доступ по ID                                         |
| GameReview    | idx_game_review_game_id_created_at (game_id, created_at)                         | B-Tree          | 12 байт             | 43.3M       | 519.6 MB        | Отображение отзывов с сортировкой по дате            |
| TradeOffer    | idx_trade_offer_id (owner_user_id, id, item_id)                                  | B-Tree          | 33 байт             | 75.9 млрд   | 2.5047 TB       | Доступ по ID                                         |
| TradeOffer    | idx_trade_offer_dir_status_date (owner_user_id, is_outgoing, status, created_at) | B-Tree          | 24 байт             | 75.9 млрд   | 1.8216 TB       | Просмотр предложений с сортировкой по дате           |
| TradeOffer    | idx_owner_item_name (owner_user_id, item_name)                                   | GIN             | 24 байт             | 75.9 млрд   | 1.8216 TB       | Поиск предметов по названию                          |

#### Elasticsearch
Для реализации функции поиска воспользуемся поисковым движком Elasticsearch. Он прекрасно справится с полнотекстовым поиском при помощи построения обратного индекса (когда нам известны места, где встречается текст. Нет нужды сканить всю таблицу)
| Таблица             | Индекс                                             | Пояснение                           | Размер одной строки | Всего строк | Итоговый размер |
|---------------------|----------------------------------------------------|-------------------------------------|---------------------|-------------|-----------------|
| GameSearch          | games (game_id, title, developer_name)             | Поиск игр в магазине по названию    | 36 байт (4+16+16)   | 114662      | 4.1278 MB       |
| MarketListingSearch | market_listings (item_id, item_name)               | Поиск предмета на торговой площадке | 24 байт (8+16)      | 28M         | 672 MB          |
| UserSearch          | users (user_id, profile_name)                      | Поиск пользователя по имени         | 40 байт (8+32)      | 982М        | 39.28 GB        |

### Шардирование и резервирование СУБД
#### Шардирование
- Будем шардировать UserLibrary по ключу user_id. Тем самым снизим нагрузку на запись, уменьшим размер индексов. Выберем число шардов 8. Тогда размер индекса будет 37.8 GB.
- Будем шардировать TradeOffer по ключу owner_user_id. Тем самым уменьшим размер индекса и при этом решим задачу поиска конкретных предметов в рамках конкретного пользователя. Выберем число шардов 128, тогда размер индекса будет 48 GB  

#### Горизонтальное масштабирование в Cassandra
Каждый узел равноправный (peer-to-peer), имеет те же возможности чтения и записи, что и другие узлы и отвечает за собственный раздел данных. Узлы объединяются в кольцо (кластер), а данные реплицируются между ними для обеспечения отказоустойчивости.  
Cassandra использует Ключ Партицирования (Partition Key), заданный разработчиком, для вычисления токена, который определяет, на каком узле будут храниться данные.  
<img width="636" height="613" alt="image" src="https://github.com/user-attachments/assets/749f3df6-467d-46bf-a99e-95a13dd70699" />  

#### Резервирование
Будем использовать 1 master + 2 реплики. Такой подход оптимален т.к.:
- При выходе из строя одной реплики, останется вторая.
- При выходе из строя master, одна из двух реплик будет повышена до master без потери данных и с минимальным временем простоя
- Можно поочередно обслуживать реплики

### Выбор СУБД
| Таблица        | СУБД       | Комментарий                                                                           |
|----------------|------------|---------------------------------------------------------------------------------------|
| User           | MongoDB    | Документоориентированно, гибкая схема для возможных будущих фич с профилем, аккаунтом |
| UserSession    | Redis      | Высокая скорость, TTL                                                                 |
| Currency       | Tarantool  | Таблица маленькая, легко поместится в RAM                                             |
| Developer      | Tarantool  | Таблица маленькая, легко поместится в RAM                                             |
| Game           | Tarantool  | Таблица маленькая, легко поместится в RAM                                             |
| GameDetails    | Tarantool  | Таблица маленькая, легко поместится в RAM                                             |
| GamePrice      | Tarantool  | Таблица маленькая, легко поместится в RAM                                             |
| UserLibrary    | Cassandra  | Высокая операция записи, структура библиотеки не будет кардинально меняться           |
| Item           | MongoDB    | Документоориентированно, гибкая схема для возможных будущих фич с предметами          |
| UserInventory  | MongoDB    | Документоориентированно, гибкая схема для возможных будущих фич с предметами          |
| MarketListing  | MongoDB    | Документоориентированно, гибкая схема для возможных будущих фич с списком             |
| GameReview     | MongoDB    | Документоориентированно, гибкая схема для возможных будущих фич с отзывами            |
| TradeOffer     | MongoDB    | Лежит информация о предметах, юзерах. Хорошо ложится в формате документа              |

### Клиентские библиотеки
- MongoDB: [mongo-go-driver](https://github.com/mongodb/mongo-go-driver)
- Redis: [go-redis](https://github.com/redis/go-redis)
- Tarantool: [go-tarantool](https://github.com/tarantool/go-tarantool)
- Cassandra [gocsql-driver](https://github.com/apache/cassandra-gocql-driver)

## 8. Технологии
| Технология    | Область применения       | Комментарий                                                     |
|---------------|--------------------------|-----------------------------------------------------------------|
| Typescript    | Frontend                 | Строгая типизация                                               |
| React         | Frontend                 | Компонентный подход, реактивность                               |
| Go            | Backend                  | Высокая производительность, многозадачность                     |
| ElectronJS    | Десктопное приложение    | Кроссплатформенная сборка, в основе браузер                     |
| MongoDB       | Хранилище данных         | Документоориентированная, гибкая схема                          |
| Cassandra     | Хранилище данных         | Колоночная, выдерживает высокие нагрузки на запись              |
| Tarantool     | Хранилище данных         | In-memory с сохранением состояния                               |
| Elasticsearch | Поиск                    | Полнотекстовый поиск                                            |
| Redis         | Хранилище сессий         | In-memory                                                       |
| Docker        | Контейнеризация          | Разворачивание сервиса в изолированной среде, переносимость     |
| Kubernetes    | Оркестрация контейнеров  | Масштабируемость, управление большими распределенными системами |
| Nginx         | L7 балансировка нагрузки | Балансировка, сжатие трафика, кэшироваие, SSL терминация        |
| Kafka         | Обмен сообщениями        | Взаимодействие микросервисов, надежная доставка сообщений       |
| Prometheus    | Сбор метрик              | Сбор и хранение метрик                                          |
| Grafana       | Визуализация метрик      | Кастомизируемые дашборды, визуализация данных (Prometheus)      |

## 9. Обеспечение надежности
### Физическая надежность
- Установка ИБП, использование запасных линий электроэнергии
- Соблюдение температурного режима
- Наличие запасного оборудования, дублирование коммутаторов, маршрутизаторов
- Датчики задымленности

### Graceful Shutdown
При получении сигнала о необходимости завершения, микросервис перестает принимать новые запросы, выполняет все оставшиеся запросы, после чего завершает свою работу.

### Graceful Degradation
- В случае, если какая-та часть системы перестанет функционировать, другие части системы продолжат свою работу в штатном режиме (например, если отвалится сервис отзывов, мы можем игнорировать это и отображать остальную информацию об игре).
- После восстановления работы, сервис подтянет события с Kafka, обработает их и продолжит свою работу в штатном режиме.

### Асинхронные паттерны
- В основе архитектуры будем использовать паттерн Event-driven на базе Kafka
- Для сложных взаимодействий между несколькими микросервисами будем использовать паттерн Saga (оркестратор) для транзакций.

### Мониторинг
- Каждый микросервис собирает метрики, за которыми потом ходит Prometheus. Далее эти метрики визуализируются в Grafana
- Логгирование ошибок. Каждый запрос имеет уникальный ID, благодаря которому можно будет сделать трассировку по логам.

## 10. Схема проекта
![Steam-second](https://github.com/user-attachments/assets/c8aaf7b4-e4ef-41ec-8670-b8495d193c49)

### Пояснение Saga
1. Магазин игр
  - Пользователь хочет купить игру
  - Создается заказ в магазине в статусе ожидания
  - Оркестратор отправляет запрос через Kafka, что необходимо снять деньги
  - Оркестратор получает ответ об успешности операции
    - Если операция не успешна - помечаем заказ как failed
    - Если операция успешна - Оркестратор отправляет запрос через Kafka что нужно добавить игру в библиотеку пользователя
  - Оркестратор получает ответ об успешности операции
    - Если операция не успешна - откатываем баланс пользователя через Kafka, помечаем заказ как failed
    - Если операция успешна - помечаем заказ как выполненный
2. Торговая площадка
  - Пользователь хочет купить предмет у другого пользователя
  - Создается заказ в статусе ожидания
  - Оркестратор отправляет запрос через Kafka, что необходимо снять деньги
  - Оркестратор получает ответ об успешности операции
    - Если операция не успешна - помечаем заказ как failed
    - Если операция успешна - Оркестратор отправляет запрос через Kafka что нужно поменять владельца предмета
  - Оркестратор получает ответ об успешности операции
    - Если операция не успешна - откатываем баланс пользователя через Kafka, помечаем заказ как failed
    - Если операция успешна - помечаем заказ как выполненный
3. Торговый обмен
  - Пользователь хочет принять обмен от другого пользователя
  - Оркестратор отправляет запрос через Kafka, что необходимо поменять владельцев предметов
  - Оркестратор получает ответ об успешности операции
    - Если операция не успешна - помечаем оффер как failed
    - Если операция успешна - помечаем оффер как завершенный

## 11. Список серверов
### Сервисы
На 1 CPU ядро выделим следующие сложности логики сервисов:
- Тяжелая: на 10 RPS, RAM: 100 MB
- Средняя: на 100 RPS, RAM: 100 MB
- Легкая: на 5000 RPS, RAM: 10 MB

Также будем домножать на 1.5, чтобы заложить нагрузку на случай, если какой-то из датацентров станет недоступен.  

| Сервис                  | Пиковый RPS | Сложность | CPU (ядра) | RAM (Гб) |
|-------------------------|-------------|-----------|------------|----------|
| Пополнение кошелька     | 6           | Тяжелая   | 1          | 1        |
| Поиск                   | 1597        | Легкая    | 1          | 1        |
| Авторизация             | 72          | Легкая    | 1          | 1        |
| Пользователи            | 778.8       | Средняя   | 12         | 2        |
| Разработчики            | 1           | Легкая    | 1          | 1        |
| Магазин игр             | 4134        | Средняя   | 62         | 7        |
| Библиотека пользователя | 25336.5     | Легкая    | 8          | 1        |
| Игры                    | 1           | Легкая    | 1          | 1        |
| Отзывы к играм          | 4122.405    | Средняя   | 62         | 7        |
| Игровые предметы        | 1           | Легкая    | 1          | 1        |
| Курс валют              | 1           | Легкая    | 1          | 1        |
| Торговая площадка       | 19.3        | Тяжелая   | 3          | 1        |
| Инвентарь пользователя  | 432         | Легкая    | 1          | 1        |
| Торговый обмен          | 69.48       | Тяжелая   | 11         | 2        |
| Всего                   | 36571.485   | -         | 166        | 28       |

### Хранилища
Хранилище будет постоянно расти (новые пользователи, иные записи). Учитывая амортизацию в 20%, надо заложить место в хранилище на лет 5. За год число пользователей растет на 63М человек (~10%). Следовательно и в других местах объем в среднем вырастет минимум на 10%. Заложим 50% в объем.  
Также не забудем про резервирование.  

Тогда получим:
| Хранилище     | Диск (Гб)   | Пиковый QPS | CPU (ядра) | RAM (Гб) |
|---------------|-------------|-------------|------------|----------|
| Tarantool     | 3           | 8280        | 6          | 6        |
| Cassandra     | 2721        | 25324.2     | 40         | 80       |
| MongoDB       | 130710      | 3074.4      | 768        | 6206.1   |
| Redis         | 639         | 25569.7     | 39         | 213      |
| ElasticSearch | 180         | 1597        | 9          | 96       |
| S3            | 8010000     | 9114        | 6          | 96       |

### S3
#### Игры:
- Размер файлов всех игр: 20 GB * 114662 = 2.2932 PB
- Размер скриншотов (~8 шт) всех игр: 3.1 MB * 114662 = 355.45 GB
- Размер шапок всех игр: 44 KB * 114662 = 5.0451 GB
- Общий размер: 2.405 PB

#### Пользователи
- Размер аватарок: 11 KB * 982М = 10.802 TB

#### Предметы
- Размер картинок предметов: 38 KB * 28M = 1.064 TB

Общий размер с учетом запаса: 2.405 PB * 1.1 + 10.802 TB * 1.5 + 1.064 TB * 1.1 = 2.67 PB

### Конфигурации серверов

| Название      | Конфигурация               | CPU (ядра) | RAM (Гб) | Количество | Покупка одного | Аренда одного (1 год) |
|---------------|----------------------------|------------|----------|------------|----------------|-----------------------|
| Kubenode      | 2x4314/2x16GB/1xNvMe1900GB | 32         | 32       | 24         | 7195$          | 11000$                |
| Cassandra     | 2x4310/2x16GB/2xNvMe600GB  | 24         | 32       | 8          | 5645$          | 16000$                |
| MongoDB       | 2x6138/2x64GB/2xNVMe600GB  | 40         | 128      | 49         | 3500$          | 24000$                |
| Tarantool     | 1x3106/1x16GB/1xNVMe59GB   | 8          | 16       | 4          | 1330$          | 855$                  |
| Redis         | 2x4208/2x32GB/1xNVMe950GB  | 16         | 64       | 4          | 3180$          | 7932$                 |
| ElasticSearch | 1x4208/1x32GB/1xNVMe300GB  | 8          | 32       | 4          | 2607$          | 3609$                 |


### Распределение серверов по ДЦ
| Регион           | Количество ДЦ | Kubenode | Cassandra | MongoDB  | Tarantool | Redis | ElasticSearch |
|------------------|---------------|----------|-----------|----------|-----------|-------|---------------|
| Азия             | 2             | 12       | 4         | 25       | 2         | 2     | 2             |
| Европа           | 1             | 6        | 2         | 12       | 1         | 1     | 1             |
| Северная Америка | 1             | 6        | 2         | 12       | 1         | 1     | 1             |

## Список использованных источников
[^1]: [Steamworks ](https://partner.steamgames.com/)
[^2]: [Steam Statistics 2025: Users & Revenue Data](https://www.demandsage.com/steam-statistics/#:~:text=Steam%20has%20132%20million%20monthly%2Ctime%20high%20of%20%2410.8%20billion)
[^3]: [Steam Users by Country 2025](https://worldpopulationreview.com/country-rankings/steam-users-by-country)
[^4]: [Trade.TF - Trade Volume](https://www.trade.tf/volume)
[^5]: [Steam Market Data | Video Game Insights](https://app.sensortower.com/vgi/steam-market-data)
[^6]: [Steam Game Release Summary by Year · SteamDB](https://steamdb.info/stats/releases/)
[^7]: [Steam in 2017](https://media.gdcvault.com/gdc2018/presentations/Steam_in_2017.pdf)
[^8]: [Steam | Market Overview](https://csgoskins.gg/markets/steam)
[^9]: [Где мои деньги, чувак: о чем молчит Steam](https://habr.com/ru/articles/423215/)
[^10]: [Scanning all possible Steam IDs, and what we have found](https://steamdb.info/blog/scanning-all-steam-ids/)
[^11]: [Steam: Game and Player Statistics](https://store.steampowered.com/stats/content/)
[^12]: [How to Estimate Steam Video Game Sales?](https://app.sensortower.com/vgi/insights/article/how-to-estimate-steam-video-game-sales)
[^13]: [Поддерживаемые валюты (документация Steamworks)](https://partner.steamgames.com/doc/store/pricing/currencies?l=russian)
[^14]: [There are 44,000 game developers on Steam. Who are they?](https://www.gamedeveloper.com/game-platforms/there-are-44-000-game-developers-on-steam-who-are-they-)
[^15]: [What 'Steam review count' tells us about your game](https://newsletter.gamediscover.co/p/what-steam-review-count-tells-us)
