# Курсовая работа по предмету "Проектирование высоконагруженных систем"

## Содержание
- [1. Тема и целевая аудитория](#1-тема-и-целевая-аудитория)
  - [Тема](#тема)
  - [Целевая аудитория](#целевая-аудитория)
  - [Топ 5 по числу пользователей стран](#топ-5-по-числу-пользователей-стран)
  - [Функционал](#функционал)
- [2. Расчет нагрузки](#2-расчет-нагрузки)
  - [Продуктовые метрики](#продуктовые-метрики)
    - [Аудитория](#аудитория)
    - [Средний размер хранилища](#средний-размер-хранилища)
    - [Среднее количество действий пользователя](#среднее-количество-действий-пользователя)
  - [Технические метрики](#технические-метрики)
    - [Размер хранения](#размер-хранения)
    - [Сетевой трафик](#сетевой-трафик)
- [3. Глобальная балансировка нагрузки](#3-глобальная-балансировка-нагрузки)
    - [Разбиение по доменам](#разбиение-по-доменам)
    - [Расположение ДЦ](#расположение-дц)
    - [Схема DNS балансировки](#схема-dns-балансировки)
    - [Схема Anycast балансировки](#схема-anycast-балансировки)
- [4. Локальная балансировка нагрузки](#4-локальная-балансировка-нагрузки)
    - [L4 балансировка](#l4-балансировка)
    - [L7 балансировка](#l7-балансировка)
    - [Межсервисное взаимодействие](#межсервисное-взаимодействие)
    - [Терминация SSL](#терминация-ssl)
- [5. Логическая схема БД](#5-логическая-схема-БД)
    - [Описание таблиц](#описание-таблиц)
    - [Размеры данных](#размеры-данных)
    - [Требования к консинстентности](#требования-к-консинстентности)
    - [Нагрузка на чтение и запись](#нагрузка-на-чтение-и-запись)
- [6. Физическая схема БД](#6-физическая-схема-бд)
    - [Денормализация](#денормализация)
    - [Индексы](#индексы)
    - [Выбор СУБД](#выбор-субд)
    - [Шардирование и резервирование СУБД](#шардирование-и-резервирование-субд)
    - [Клиентские библиотеки](#клиентские-библиотеки)
- [Список использованных источников](#список-использованных-источников)

## 1. Тема и целевая аудитория

### Тема
  **Steam** — онлайн-сервис цифрового распространения компьютерных игр и программ.

### Целевая аудитория
  - 69 миллионов ежедневных активных пользователей (DAU). [^2]
  - 132 миллиона ежемесячных активных пользователей (MAU). [^1]
  - Пик одновременных пользователей онлайн - 39.31 млн [^2]

### Топ 5 по числу пользователей стран:
  Информация взята с источника [^3]
  | Страна   | Число пользователей |
  |----------|---------------------|
  | США      | 13.7 млн           |
  | Китай    | 11.4 млн            |
  | Россия   | 9.5 млн             |
  | Бразилия | 4.9 млн             |
  | Германия | 3.6 млн             |

### Функционал
 Основной фукционал сервиса заключается в приобретении игр и обмене/продаже внутриигровых предметов

 Функционал MVP:
 - Регистрация и аутентификация
 - Список игр (магазин)
 - Корзина с добавленными играми
 - Торговая площадка
 - Библиотека игр пользователя
 - Система торгового предложения по обмену внутриигровыми предметами (trade offer)
 - Профиль пользователя

## 2. Расчет нагрузки
### Продуктовые метрики:
#### Аудитория
- 69 миллионов ежедневных активных пользователей (DAU). [^2]
- 132 миллиона ежемесячных активных пользователей (MAU). [^1]
#### Средний размер хранилища
Профиль
| Данные             | Средний размер                          |
|--------------------|-----------------------------------------|
| Аватарка           | 11 KB                                   | 
| Информация профиля | 28 байт                                 |
| Статистика игр     | 231 байт (21 байт на 1 игру)            |
| Сумма              | 11.259 KB                               |

- Информация профиля: имя (10 символов, 20 байт) + краткое описание (4 символа, 8 байт)
- Статистика игры: идентификатор игры (4 байта) + кол-во часов (4 байта) + последний запуск (13 байт)
- Согласно [^7] в среднем у пользователя 11 игр. Отсюда получаем 21 * 11 = 231 байт

Игра
| Данные                  | Средний размер                |
|-------------------------|-------------------------------|
| Шапка                   | 44 KB                         |
| Скриншот                | 3.1 MB (389 KB на 1 скриншот) |
| Информация              | 4 KB                          |
| Файлы игры              | 20 GB                         |
| Сумма                   | 20.003148 GB                  |

- Было проанализировано 1000 случайных игр из магазина Steam
- В среднем у игры 8 скриншотов. Отсюда получаем 8 * 389 KB = 3.1 MB

Игровой предмет
| Данные             | Средний размер      |
|--------------------|---------------------|
| Идентификатор игры | 4 байта             |
| Картинка           | 38 KB               |
| Название           | 40 байт             |
| Описание           | 238 байт            |
| Сумма              | 38.282 KB           |

- Каждый символ весит 2 байта.

#### Среднее количество действий пользователя
| Действие                                             | Среднее число в день |
|------------------------------------------------------|----------------------|
| Регистрация/Аутентификация                           | 0.03                 |
| Просмотр игры                                        | 1.72                 |
| Покупка игры                                         | 0.005                |
| Скачивание игры                                      | 1.57                 |
| Совершение торгового обмена                          | 0.029                |
| Выставление предмета на продажу на торговой площадке | 0.0007               |
| Просмотр предмета на торговой площадке               | 0.007                |
| Покупка предмета на торговой площадке                | 0.00035              |
| Просмотр профиля                                     | 0.295                |
| Обновление профиля                                   | 0.03                 |
| Просмотр предметов                                   | 0.18                 |
| Отзыв об игре                                        | 0.00017              |

- Пользователь авторизуется в Steam в среднем раз в месяц. Тогда в день: 1 / 30 = 0.03
- Продано игр за год: 132М [^5] => За день: 132M / 365 = 361643 => один пользователь в среднем за день покупает: 361643 / 69M = 0.005
- Расчитаем число просмотров игры:
  - Согласно [^9] средняя конверсия: от 2 до 4%. Возьмем среднее: 3%. То есть для одной покупки необходимо: 1 / 0.03 = 33 посещения.
  - Предположим, что пользователь просматривает в среднем 10 страниц с играми. Тогда: 33 * 10 = 330 посещений.
  - Тогда общее число просмотров в день: 361643 * 330 = 119М
  - Тогда на одного пользователя: 119M / 69M = 1.72
- Учитывая что в среднем у пользователя 11 игр [^7] и предположив, что игры обновляются раз в неделю, то в день на 1 пользователя получим: 11 / 7 = 1.57
- Созданных торговых предложений за месяц: 58M [^4] => За день 58M / 30 = 2M => один пользователь в среднем создает торговых обменов: 2M / 69M = 0.029
- За период 1 января 2024 - 1 января 2025 согласно [^8] выставлялось 18.9М предметов => за день: 18.9M / 365 = 51780 => один пользователь в среднем выставляет на продажу: 0.0007
- За период 1 января 2024 - 1 января 2025 согласно [^8] в среднем было 172М посещений => за день: 172М / 365 = 471232 => один пользователь в среднем смотрит предметы: 0.007
- Зная метрику просмотров предмета на торговой площадке и метрику выставления предмета на продажу на торговой площадке, оценим метирку покупок. Предположим, что конверсия 5% (т.е. 1 из 20 предметов покупают). Тогда: 0.007 / 20 = 0.00035
- Чтобы обновить профиль, его надо открыть. Также следует учитывать что перед совершением обмена также будет смотреться профиль пользователя. Предположим, что каждое такое действие порождает в среднем 5 просмотров профилей. Тогда получим: (0.03 + 0.029) * 5 = 0.295
- Пользователь обновляет данные профиля в среднем раз в месяц. Тогда в день: 1 / 30 = 0.03
- Чтобы выставить предмет на продажу или совершить обмен, необходимо посмотреть инвентарь с предметами. Предположим что каждое такое действие порождает в среднем 5 просмотров инвентаря. Тогда получим: (0.029 + 0.007) * 5 = 0.18
- Согласно [^12] на 1 отзыв приходится ~30 продаж. Тогда зная метрику покупки игры получим: 0.005 / 30 = 0.00017

### Технические метрики
#### Размер хранения
| Тип данных      | Размер для одного | Количество | Размер для всех |
|-----------------|-------------------|------------|-----------------|
| Пользователь    | 11.259 KB         | 982М       | 11 TB           |
| Игра            | 20.003148 GB      | 114662     | 2.3 PB          |
| Игровой предмет | 38.282 KB         | 28M        | 1.0719 TB       |

- Согласно [^10] на момент 2020 года в Steam было зарегистрировано 667М аккаунтов. Согласно [^7] в 2017 году прирост пользователей был 63М. Тогда к 2025 получим: 667М + 63М * 5 = 982М.
  - Тогда: 11.259 KB * 982M = 11 TB
- Согласно [^6] в Steam на данный момент 114662 игр. Тогда: 20.003148 GB * 114662 = 2.3 PB
- Согласно [^8] в Steam на торговой площадке выставлено на продажу 28М игровых предметов. Тогда: 38.282 KB * 28M = 1.0719 TB

#### Сетевой трафик
RPS
- Для расчета воспользуемся таблицей с действиями пользователя и формула: (количество запросов в день от одного пользователя * DAU) / 86400
- Пиковый RPS возьмем в 3 раза выше среднего (согласно [^11]). В нашем сервисе пользователи расположены в разных часовых поясах, потому пиковая нагрузка будет не настолько резко большой.

| Действие                                             | RPS                | RPS в пике        |
|------------------------------------------------------|--------------------|-------------------|
| Регистрация/Аутентификация                           | 24                 | 72                |
| Просмотр игры                                        | 1374               | 4122              |
| Покупка игры                                         | 4                  | 12                |
| Скачивание игры                                      | 1254               | 3762              |
| Совершение торгового обмена                          | 23.16              | 69.48             |
| Выставление предмета на продажу на торговой площадке | 0.55               | 1.65              |
| Просмотр предмета на торговой площадке               | 5.6                | 16.8              |
| Покупка предмета на торговой площадке                | 0.28               | 0.84              |
| Просмотр профиля                                     | 235.6              | 706.8             |
| Обновление профиля                                   | 24                 | 72                |
| Просмотр предметов                                   | 144                | 432               |
| Отзыв об игре                                        | 0.135              | 0.405             |

Общая нагрузка
- Формула для средней нагрузки: трафик * RPS
- Пиковую нагрузку возьмем в 3 раза выше средней

| Действие                                             | Трафик на действие (request + response) | Средняя нагрузка (Гбит/с) | Пиковая нагрузка (Гбит/с) |
|------------------------------------------------------|-----------------------------------------|---------------------------|---------------------------|
| Аутентификация                                       | 1 KB (888 байт + 174 байт)              | 0.000192                  | 0.000576                  |
| Просмотр игры                                        | 5.808 MB (2.66 KB + 3.148 MB)           | 63.8415                   | 191.5245                  |
| Покупка игры                                         | 449 байт (286 байт + 163 байт)          | 0.000014                  | 0.000042                  |
| Скачивание игры                                      | 20 GB                                   | 200640                    | 601920                    |
| Совершение торгового обмена                          | 2.719 KB (2.61 KB + 109 байт)           | 0.0005                    | 0.0015                    |
| Выставление предмета на продажу на торговой площадке | 2.256 KB (2.15 KB + 106 байт)           | 0.00001                   | 0.00003                   |
| Просмотр предмета на торговой площадке               | 42.11 KB (2.11 KB + 40 KB)              | 0.0019                    | 0.0057                    |
| Покупка предмета на торговой площадке                | 2.24 KB (2.23 KB + 151 байт)            | 0.000005                  | 0.000015                  |
| Просмотр профиля                                     | 13.37 KB (2.11 KB + 11.259 KB)          | 0.0252                    | 0.0756                    |
| Обновление профиля                                   | 4.4 KB (4.36 KB + 45 байт)              | 0.0008                    | 0.0024                    |
| Просмотр предметов                                   | 0.96 MB (2.11 KB + 38.282 KB * 25)      | 1.1059                    | 3.3177                    |
| Отзыв об игре                                        | 2.22 KB (2.21 KB + 33 байт)             | 0.0000024                 | 0.0000072                 |

- На одной странице с предметами 25 игровых предметов

## 3. Глобальная балансировка нагрузки
### Разбиение по доменам
В рамках нашего MVP будем использовать поддомены:
- game.steam.com - для скачивания игр
- community.steam.com - для взаимодействия с системами комьюнити (обмен/продажа предметов, профили, покупка игр, ...)

### Расположение ДЦ
На основе информации об использовании трафика [^11]:  
<img width="616" height="556" alt="image" src="https://github.com/user-attachments/assets/a618bda7-cd2a-40c7-8e1c-efd9e0cb1b6b" />  
а также карт [^11]:  
<img width="908" height="454" alt="image" src="https://github.com/user-attachments/assets/e760ddfc-00cd-42c8-80a9-acbea9e55010" />  
<img width="907" height="461" alt="image" src="https://github.com/user-attachments/assets/7e41bfb4-fd2f-4179-8ad0-5bbe6187b9ea" />  
расположим ДЦ следующим образом (регионы расположены от наиболее нагруженных к менее нагруженным).  
  
Скачивание игр является несложной операцией, датацентры выберем следующим образом:
- Азия: Пекин (Китай), Токио (Япония)
- Европа: Франкфурт (Германия)
- Северная Америка: Сан Хосе (Калифорния)
  
Для прочего функционала:
- Азия: Пекин (Китай), Токио (Япония)
- Европа: Франкфурт (Германия)
- Северная Америка: Сан Хосе (Калифорния)

Карта расположенных ДЦ:  
<img width="965" height="538" alt="image" src="https://github.com/user-attachments/assets/bfda6615-eee7-44ec-9f90-cb9e353dfe3e" />

### Расчет распределения запросов
Согласно [^11], общий трафик:
| Регион           | Использовано трафика всего (Tbps) |
|------------------|-----------------------------------|
| Азия             | 13.6                              |
| Европа           | 12.8                              |
| Северная Америка | 8.8                               |
| Ближний Восток   | 1.1                               |
| Океания          | 0.83                              |
| Южная Америка    | 3.1                               |

Пусть Ближний Восток будет равномерно распределятся между европейским и азиатским регионами, Океания будет использовать азиатский регион, а Южная Америка северо-американский регион. Тогда получим:
| Регион           | Использовано трафика всего (Tbps) |
|------------------|-----------------------------------|
| Азия             | 14.98                             |
| Европа           | 13.35                             |
| Северная Америка | 11.9                              |

Скачивание игр занимает большую часть трафика (~98%), согласно посчитанной ранее нагрузке.  
Тогда согласно [^11], а также выбранным ранее датацентрам для скачивания:
| Регион           | Использовано трафика (Tbps)       | Число датацентров | Трафик на 1 датацентр (Tbps) |
|------------------|-----------------------------------|-------------------|------------------------------|
| Азия             | 14.6804                           | 2                 | 7.3402                       |
| Европа           | 13.083                            | 1                 | 13.083                       |
| Северная Америка | 11.662                            | 1                 | 11.662                       |

Для остального трафика:
| Регион           | Использовано трафика (Tbps)       | Число датацентров | Трафик на 1 датацентр (Tbps) |
|------------------|-----------------------------------|-------------------|------------------------------|
| Азия             | 0.2996                            | 2                 | 0.1498                       |
| Европа           | 0.26166                           | 1                 | 0.26166                      |
| Северная Америка | 0.23324                           | 1                 | 0.23324                      |

Переводя в процентное соотношение регионы по формуле: (трафик региона / общий трафик) * 100%:
| Регион           | Процентная доля трафика     |
|------------------|-----------------------------|
| Азия             | 37.24                       |
| Европа           | 33.2                        |
| Северная Америка | 29.6                        |

Посчитаем RPS считать по формуле: (RPS на действие) * (% трафика региона)
| Действие                                             | Азия    | Европа | Северная Америка |
|------------------------------------------------------|---------|--------|------------------|
| Скачивание игры                                      | 1400.97 | 1249   | 1113.55          |
| Остальной функционал                                 | 2050.42 | 1828   | 1630             |

Посчитаем RPS по датацентрам: (RPS из региона) / кол-во датацентров  
Для скачивания игр:  
| Регион           | RPS     | Число датацентров | RPS на 1 датацентр |
|------------------|---------|-------------------|--------------------|
| Азия             | 1400.97 | 2                 | 700.485            |
| Европа           | 1249    | 1                 | 1249               |
| Северная Америка | 1113.55 | 1                 | 1113.55            |

Для прочего функционала:  
| Регион           | RPS     | Число датацентров | RPS на 1 датацентр |
|------------------|---------|-------------------|--------------------|
| Азия             | 2050.42 | 2                 | 1025.21            |
| Европа           | 1828    | 1                 | 1828               |
| Северная Америка | 1630    | 1                 | 1630               |

### Схема DNS балансировки
Будем использовать Geo-based DNS, т.к. сервисом пользуются по всему миру.

### Схема Anycast балансировки
Дополнительно к DNS балансировке в высоконагруженных регионах (Азия, Северная Америка, Европа) можно воспользоваться BGP Anycast для более точного выбора датацентра.

## 4. Локальная балансировка нагрузки

### L4 балансировка
L4 балансировка не требуется, т.к. L7 балансировка более чем справится с полученным пиковым RPS.

### L7 балансировка
Будем использовать Nginx (2 сервера). Один активен, другой нет. Если первый сервер упадет, второй войдет в работу (можно реализовать при помощи keepalived по VRRP)
В качестве балансировки используется алгоритм Weighted Round-Robin, чтобы равномерно распределить нагрузку. Будем кэшировать статический контент. Дополнительно можно сжимать трафик (gzip)
Дополнительно развернем в каждом датацентре кластер Kubernetes для автоматического контроля, перезапуска упавших узлов, а также возможности легкого горизонтального масштабирования. Для отслеживания состояния приложения будем использовать health-check запросы.

### Межсервисное взаимодействие
При взаимодействии одного микросервиса внутри Kubernetes с другим происходит следующий процесс:  
- Обращение к Ingress-контроллеру
- Ingress-контроллер берет домен микросервиса, к которому нужно обратиться и просит у нужного service IP-адрес пода, куда нужно перенаправить трафик.
<img width="1319" height="854" alt="image" src="https://github.com/user-attachments/assets/b4405539-d66c-4e53-a015-7c916e0b8e96" />

### Терминация SSL
Будет происходить на L7 уровне в Nginx. Дополнительно будем использовать session ticket.

## 5. Логическая схема БД
Схема представлена на скриншоте ниже  
<img width="1959" height="1461" alt="steam logic" src="https://github.com/user-attachments/assets/6578b55a-61bc-4040-9693-ba740cd83505" />

### Описание таблиц
| Таблица         | Описание |
|-----------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| User            | Данные о пользователях: id пользователя, логин (username), email, хеш пароля, имя профиля, описание профиля, URL аватарки (из CDN), дата создания (created_at), дата изменения (updated_at)                                                                               |
| UserSession     | Данные о сессиях пользователя: id сессии, id пользователя, токен, дата истечения, дата создания (created_at), дата изменения (updated_at)                                                                                                                                  |
| Currency        | Данные о валютах: id валюты, короткое наименование, полное наименование, курс к USD, дата создания (created_at), дата изменения (updated_at)                                                                                                                              |
| UserWallet      | Данные о кошельках пользователей: id кошелька, id пользователя, id валюты, баланс, дата создания (created_at), дата изменения (updated_at)                                                                                                                                |
| Developer       | Данные о разработчиках игр: id разработчика, имя, описание, дата создания (created_at), дата изменения (updated_at)                                                                                                                                                       |
| Game            | Данные об играх: id игры, id разработчика, название, описание, URL шапки (из CDN), дата выпуска, дата создания (created_at), дата изменения (updated_at)                                                                                                                  |
| GamePrice       | Данные о ценах игры: id, id игры, id валюты, цена, дата создания (created_at), дата изменения (updated_at)                                                                                                                                                                |
| GameScreenshot  | Данные о скриншотах игры: id, id игры, URL скриншота (из CDN), дата создания (created_at), дата изменения (updated_at)                                                                                                                                                    |
| UserLibrary     | Данные об играх пользователя в библиотеке: id игры, id пользователя, кол-во часов, время последнего запуска, дата создания (created_at), дата изменения (updated_at)                                                                                                      |
| Item            | Данные о предметах игры: id, id игры, название, описание, картинка предмета (из CDN), дата создания (created_at), дата изменения (updated_at)                                                                                                                             |
| UserInventory   | Данные об инвентаре пользователя: id, id предмета, id пользователя, статус предмета (доступен/выставлен на торговой площадке/находится в обмене), продаваемый ли (is_marketable), передаваемый ли (is_tradeable), дата создания (created_at), дата изменения (updated_at) |
| MarketListing   | Данные о выставленных предметах на продажу: id, id предмета в инвентаре, цена в USD, дата создания (created_at), дата изменения (updated_at)                                                                                                                              |
| GameReview      | Данные об отзывах к игре: id, id пользователя, id игры, положительный ли (is_positive), текст отзыва, дата создания (created_at), дата изменения (updated_at)                                                                                                             |
| TradeOffer      | Данные о торговых предложениях: id, от пользователя (from_user_id), для пользователя (to_user_id), статус (ожидание/принят/отклонен), дата создания (created_at), дата изменения (updated_at)                                                                             |
| TradeOfferItem  | Данные о предметах в торговом предложении: id торгового предложения, id предмета из инвентаря, дата создания (created_at), дата изменения (updated_at)                                                                                                                    |

### Размеры данных
| Таблица         | Расчет размера строки                                                                                                                                                   | Размер строки | Всего строк | Размер таблицы |
|-----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------|-------------|----------------|
| User            | 8 (id) + 16 (username) + 32 (email) + 16 (password_hash) + 32 (profile_name) + 128 байт (profile_description) + 128 байт (avatar_url) + 8 (created_at) + 8 (updated_at) | 504 байт      | 982М        | 494.93 GB      |
| UserSession     | 8 (id) + 8 (user_id) + 32 (token) + 8 (expires_at) +  8 (created_at) + 8 (updated_at)                                                                                   | 72 байт       | 1.964 млрд  | 141.41 GB      |
| Currency        | 4 (id) + 4 (short_name) + 16 (display_name) + 4 (usd_currency) + 8 (created_at) + 8 (updated_at)                                                                        | 44 байт       | 47 [^13]    | 2.068 KB       |
| UserWallet      | 8 (id) + 8 (user_id) + 4 (currency_id) + 4 (balance) + 8 (created_at) + 8 (updated_at)                                                                                  | 40 байт       | 982М        | 39.28 GB       |
| Developer       | 4 (id) + 16 (name) + 128 (description) + 8 (created_at) + 8 (updated_at)                                                                                                | 164 байт      | 44000 [^14] | 7.216 MB       |
| Game            | 4 (id) + 4 (developer_id) + 16 (title) + 128 (description) + 128 (header_image_url) + 8 (release_date) + 8 (created_at) + 8 (updated_at)                                | 304 байт      | 114662      | 34.8572 MB     |
| GamePrice       | 8 (id) + 4 (game_id) + 4 (currency_id) + 4 (price) + 8 (created_at) + 8 (updated_at)                                                                                    | 36 байт       | 5.4M        | 194.4 MB       |
| GameScreenshot  | 8 (id) + 4 (game_id) + 128 (screenshot_url) + 8 (created_at) + 8 (updated_at)                                                                                           | 156 байт      | 917296      | 143.1 MB       |
| UserLibrary     | 4 (game_id) + 8 (user_id) + 4 (playtime_hours) + 8 (last_played_at) + 8 (created_at) + 8 (updated_at)                                                                   | 40 байт       | 10.8 млрд   | 432 GB         |
| Item            | 8 (id) + 4 (game_id) + 16 (name) + 128 (description) + 128 (image_url) + 8 (created_at) + 8 (updated_at)                                                                | 300 байт      | 5М          | 1.5 GB         |
| UserInventory   | 8 (id) + 8 (item_id) + 8 (user_id) + 8 (status) + 1 (is_tradeable) + 1 (is_marketable) + 8 (created_at) + 8 (updated_at)                                                | 50 байт       | 56M         | 2.8 GB         |
| MarketListing   | 8 (id) + 8 (inventory_item_id) + 4 (price) + 8 (created_at) + 8 (updated_at)                                                                                            | 36 байт       | 28M         | 1.008 GB       |
| GameReview      | 8 (id) + 8 (user_id) + 4 (game_id) + 1 (is_positive) + 256 (text) + 8 (created_at) + 8 (updated_at)                                                                     | 293 байт      | 43.3M [^15] | 12.6869 GB     |
| TradeOffer      | 8 (id) + 8 (from_user_id) + 8 (to_user_id) + 8 (status) + 8 (created_at) + 8 (updated_at)                                                                               | 48 байт       | 7.59 млрд   | 364.32 GB      |
| TradeOfferItem  | 8 (inventory_item_id) + 8 (trade_offer_id) + 8 (created_at) + 8 (updated_at)                                                                                            | 32 байт       | 37.95 млрд  | 1.2144 TB      |

### Требования к консинстентности
1. При удалении пользователя, данные в связанных таблицах удаляются (сессии, отзывы, предметы, отмена торговых предложений/лотов и тд)
2. При удалении игры, данные в связаннх таблицах удаляются (предметы игры, отзывы, и тд)
3. При удалении предмета, данные в связанных таблицах удаляются (торговый обмен, лот, инвентарь)
4. При удалении валюты, данные в связанных таблицах удаляются (цена игры), тип кошелька пользователей меняется на доступный
5. Нельзя обменять или выставить предмет на продажу, который либо уже задействован в какой-то операции, либо данная опция в предмете заблокирована
6. Операции с кошельком должны быть в формате транзакции, чтобы не потерять согласованное состояние

### Нагрузка на чтение и запись
| Действие                                             | RPS                | RPS в пике        | Запросы БД                                                                                                 | Средний QPS (Чтение) | Пиковый QPS (Чтение) | Средний QPS (Запись) | Пиковый QPS (Запись) |
|------------------------------------------------------|--------------------|-------------------|------------------------------------------------------------------------------------------------------------|----------------------|----------------------|----------------------|----------------------|
| Регистрация/Аутентификация                           | 24                 | 72                | 2-3 (select User, insert UserSession, insert UserWallet)                                                   | 24                   | 72                   | 48                   | 144                  |
| Просмотр игры                                        | 1374               | 4122              | 5 (select Game, select Developer, select GameScreenshot, select GamePrice, select GameReview)              | 6870                 | 20610                | 0                    | 0                    |
| Покупка игры                                         | 4                  | 12                | 3 (select UserWallet, update UserWallet, insert UserLibrary)                                               | 4                    | 12                   | 8                    | 24                   |
| Скачивание игры                                      | 1254               | 3762              | 1 (select UserLibrary)                                                                                     | 1254                 | 3762                 | 0                    | 0                    |
| Совершение торгового обмена                          | 23.16              | 69.48             | 4 (select UserInventory, insert TradeOffer, insert TradeOfferItem, update UserInventory)                   | 23.16                | 69.48                | 69.48                | 208.44               |
| Выставление предмета на продажу на торговой площадке | 0.55               | 1.65              | 3 (select UserInventory, update UserInventory, insert MarketListing)                                       | 0.55                 | 1.65                 | 0.55                 | 1.65                 |
| Просмотр предмета на торговой площадке               | 5.6                | 16.8              | 2 (select MarketListing, select Item)                                                                      | 11.2                 | 33.6                 | 0                    | 0                    |
| Покупка предмета на торговой площадке                | 0.28               | 0.84              | 5 (select UserWallet, select MarketListing, update UserWallet, update UserInventory, delete MarketListing) | 0.56                 | 1.68                 | 0.84                 | 2.52                 |
| Просмотр профиля                                     | 235.6              | 706.8             | 3 (select User, select UserInventory, select UserLibrary)                                                  | 706.8                | 2120.4               | 0                    | 0                    |
| Обновление профиля                                   | 24                 | 72                | 1 (update User)                                                                                            | 0                    | 0                    | 24                   | 72                   |
| Просмотр предметов                                   | 144                | 432               | 3 (select User, select UserInventory, select Item)                                                         | 432                  | 1296                 | 0                    | 0                    |
| Отзыв об игре                                        | 0.135              | 0.405             | 1 (insert GameReview)                                                                                      | 0                    | 0                    | 0.135                | 0.405                |

## 6. Физическая схема БД
Схема представлена на скриноте ниже  
<img width="2470" height="1569" alt="steam physical с пометками" src="https://github.com/user-attachments/assets/c537fec2-17f2-4e85-bb66-aa0ee1e79d28" />

### Денормализация
- UserWallet удален, информация о валюте и балансе внесена в User для избежания JOIN
- В User добавлены поля games_count, inventory_items_count, reviews_given_count для избежания операций COUNT
- Таблица Currency сохранена. Она очень незначительна по размеру и ей можно принебречь. Предполагается что она будет единожды подгружаться приложением при инициализации и сохраняться в ОЗУ.
- Добавлена таблица GameDetails. В нее вынесена вся информация об игре, разработчике, числе отзывов, скриншотах. Она будет использоваться при запросе просмотра игры. Таблица Game и связанные с ней будут в панели разработчика.
- В UserLibrary добавлены поля game_title и game_header_image_url для избежания JOIN
- В UserInventory добавлены поля game_id, game_title, item_name, item_description, item_image_url для избежания JOIN
- В MarketListing добавлены поля game_id, game_title, item_name, item_description, item_image_url, seller_user_id, seller_profile_name для избежания JOIN
- В TradeOffer добавлены поля from_user_name, to_user_name для избежания JOIN
- В TradeOfferItem добавлены поля from_user_id, item_id, item_name, item_description, item_image_url для избежания JOIN

### Индексы
| Таблица       | Индекс                                           | Пояснение                       | Размер одной строки | Всего строк | Итоговый размер |
|---------------|--------------------------------------------------|---------------------------------|---------------------|-------------|-----------------|
| User          | idx_user_username (username)                     | Быстрая аутентификация          | 16 байт             | 982M        | 15.712 GB       |
| User          | idx_user_email (email)                           | Быстрая регистрация/сброс       | 32 байта            | 982M        | 31.424 GB       |
| UserLibrary   | idx_user_library_by_user (user_id)               | Просмотр игр пользователя       | 8 байт              | 10.8 млрд   | 86.4 GB         |
| UserInventory | idx_inventory_by_user_game (user_id, game_id)    | Фильтрация по конкретной игре   | 16 байт (8+8)       | 56M         | 896 MB          |
| Game          | idx_games_by_developer (developer_id)            | Поиск игр по разработчику       | 4 байта             | 114662      | 447.9 KB        |
| GameReview    | idx_game_review (game_id)                        | Отзывы по игре                  | 4 байта             | 43.3M       | 173.2 MB        |
| MarketListing | idx_market_by_game (game_id)                     | Предметы по игре                | 4 байта             | 28M         | 112 MB          |
| TradeOffer    | idx_tradeoffer_from_user (from_user_id, status)  | Поиск исходящих предложений     | 16 байт (8+8)       | 7.59 млрд   | 121.44 GB       |
| TradeOffer    | idx_tradeoffer_to_user (to_user_id, status)      | Поиск входящих предложений      | 16 байт (8+8)       | 7.59 млрд   | 121.44 GB       |

#### Elasticsearch
Для реализации функции поиска воспользуемся поисковым движком Elasticsearch. Он прекрасно справится с полнотекстовым поиском при помощи построения обратного индекса (когда нам известны места, где встречается текст. Нет нужды сканить всю таблицу)

| Таблица       | Индекс                               | Пояснение                           | Размер одной строки | Всего строк | Итоговый размер |
|---------------|--------------------------------------|-------------------------------------|---------------------|-------------|-----------------|
| Game          | games (game_id, title)               | Поиск игр в магазине по названию    | 20 байт (4+16)      | 114662      | 2.2932 MB       |
| MarketListing | market_listings (item_id, item_name) | Поиск предмета на торговой площадке | 24 байт (8+16)      | 28M         | 672 MB          |
| User          | users (user_id, profile_name)        | Поиск пользователя по имени         | 40 байт (8+32)      | 982М        | 39.28 GB        |

### Выбор СУБД
| Таблица        | СУБД       | Комментарий                                                         |
|----------------|------------|---------------------------------------------------------------------|
| User           | PostgreSQL | Критически важные данные                                            |
| UserSession    | Redis      | Максимальная скорость чтения/записи, автоматическое удаление по TTL |
| Currency       | PostgreSQL | Маленькая таблица, обращение единоразовое при инициализации         |
| Developer      | PostgreSQL | Данные с низкой частотой обновления                                 |
| Game           | PostgreSQL | Редко меняется, основа для построения GameDetails                   |
| GameDetails    | MongoDB    | Документоориентированное хранилище для хранения информации об игре  |
| GamePrice      | Tarantool  | In-memory, Высокая частота чтения, сохранение состояния             |
| UserLibrary    | PostgreSQL | Значимые данные                                                     |
| Item           | PostgreSQL | Базовая информация о предметах, редко меняется                      |
| UserInventory  | PostgreSQL | Значимые данные                                                     |
| MarketListing  | MongoDB    | Горизонтальное масштабирование, отказоустойчивость                  |
| GameReview     | MongoDB    | Документоориентированное хранилище                                  |
| TradeOffer     | PostgreSQL | Строгие гарантии, что вся цепочка выполнится                        |
| TradeOfferItem | PostgreSQL | Строгие гарантии, что вся цепочка выполнится                        |

### Шардирование и резервирование СУБД
#### Резервирование
- PostgreSQL: 1 master + 2 slave
- MongoDB: 1 primary + 2 secondary узлов
- Redis: 1 master + 2 реплики
- Tarantool: Встроенные механизмы master-slave

Использование 1 master и 2 реплик оптимально по следующим причинам:
- При выходе из строя одной реплики, останется вторая.
- При выходе из строя master, одна из двух реплик будет повышена до master без потери данных и с минимальным временем простоя
- Можно поочередно обслуживать реплики

#### Шардирование
Большой пиковой нагрузки на запись в таблицах с большим объемом данных нет. Шардирование не требуется, достаточно резервировать.  
Однако потенциальными кандидатами для шардирования являются: User, UserLibrary, UserInventory, TradeOfffer, TradeOfferItem. У них большой размер, но т.к. запись там низкая, в данный момент шардирование не требуется.

### Клиентские библиотеки
- MongoDB: [mongo-go-driver](https://github.com/mongodb/mongo-go-driver)
- PostgreSQL: [pgx](https://github.com/jackc/pgx)
- Redis: [go-redis](https://github.com/redis/go-redis)
- Tarantool: [go-tarantool](https://github.com/tarantool/go-tarantool)

## Список использованных источников
[^1]: [Steamworks ](https://partner.steamgames.com/)
[^2]: [Steam Statistics 2025: Users & Revenue Data](https://www.demandsage.com/steam-statistics/#:~:text=Steam%20has%20132%20million%20monthly%2Ctime%20high%20of%20%2410.8%20billion)
[^3]: [Steam Users by Country 2025](https://worldpopulationreview.com/country-rankings/steam-users-by-country)
[^4]: [Trade.TF - Trade Volume](https://www.trade.tf/volume)
[^5]: [Steam Market Data | Video Game Insights](https://app.sensortower.com/vgi/steam-market-data)
[^6]: [Steam Game Release Summary by Year · SteamDB](https://steamdb.info/stats/releases/)
[^7]: [Steam in 2017](https://media.gdcvault.com/gdc2018/presentations/Steam_in_2017.pdf)
[^8]: [Steam | Market Overview](https://csgoskins.gg/markets/steam)
[^9]: [Где мои деньги, чувак: о чем молчит Steam](https://habr.com/ru/articles/423215/)
[^10]: [Scanning all possible Steam IDs, and what we have found](https://steamdb.info/blog/scanning-all-steam-ids/)
[^11]: [Steam: Game and Player Statistics](https://store.steampowered.com/stats/content/)
[^12]: [How to Estimate Steam Video Game Sales?](https://app.sensortower.com/vgi/insights/article/how-to-estimate-steam-video-game-sales)
[^13]: [Поддерживаемые валюты (документация Steamworks)](https://partner.steamgames.com/doc/store/pricing/currencies?l=russian)
[^14]: [There are 44,000 game developers on Steam. Who are they?](https://www.gamedeveloper.com/game-platforms/there-are-44-000-game-developers-on-steam-who-are-they-)
[^15]: [What 'Steam review count' tells us about your game](https://newsletter.gamediscover.co/p/what-steam-review-count-tells-us)
