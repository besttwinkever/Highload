# Курсовая работа по предмету "Проектирование высоконагруженных систем"

## Содержание
- [1. Тема и целевая аудитория](#1-тема-и-целевая-аудитория)
  - [Тема](#тема)
  - [Целевая аудитория](#целевая-аудитория)
  - [Топ 5 по числу пользователей стран](#топ-5-по-числу-пользователей-стран)
  - [Функционал](#функционал)
- [2. Расчет нагрузки](#2-расчет-нагрузки)
  - [Продуктовые метрики](#продуктовые-метрики)
    - [Аудитория](#аудитория)
    - [Средний размер хранилища](#средний-размер-хранилища)
    - [Среднее количество действий пользователя](#среднее-количество-действий-пользователя)
  - [Технические метрики](#технические-метрики)
    - [Размер хранения](#размер-хранения)
    - [Сетевой трафик](#сетевой-трафик)
- [3. Глобальная балансировка нагрузки](#3-глобальная-балансировка-нагрузки)
    - [Разбиение по доменам](#разбиение-по-доменам)
    - [Расположение ДЦ](#расположение-дц)
    - [Схема DNS балансировки](#схема-dns-балансировки)
    - [Схема Anycast балансировки](#схема-anycast-балансировки)
- [Список использованных источников](#список-использованных-источников)

## 1. Тема и целевая аудитория

### Тема
  **Steam** — онлайн-сервис цифрового распространения компьютерных игр и программ.

### Целевая аудитория
  - 69 миллионов ежедневных активных пользователей (DAU). [^2]
  - 132 миллиона ежемесячных активных пользователей (MAU). [^1]
  - Пик одновременных пользователей онлайн - 39.31 млн [^2]

### Топ 5 по числу пользователей стран:
  Информация взята с источника [^3]
  | Страна   | Число пользователей |
  |----------|---------------------|
  | США      | 13.7 млн           |
  | Китай    | 11.4 млн            |
  | Россия   | 9.5 млн             |
  | Бразилия | 4.9 млн             |
  | Германия | 3.6 млн             |

### Функционал
 Основной фукционал сервиса заключается в приобретении игр и обмене/продаже внутриигровых предметов

 Функционал MVP:
 - Регистрация и аутентификация
 - Список игр (магазин)
 - Корзина с добавленными играми
 - Торговая площадка
 - Библиотека игр пользователя
 - Система торгового предложения по обмену внутриигровыми предметами (trade offer)
 - Профиль пользователя

## 2. Расчет нагрузки
### Продуктовые метрики:
#### Аудитория
- 69 миллионов ежедневных активных пользователей (DAU). [^2]
- 132 миллиона ежемесячных активных пользователей (MAU). [^1]
#### Средний размер хранилища
Профиль
| Данные             | Средний размер                          |
|--------------------|-----------------------------------------|
| Аватарка           | 11 KB                                   | 
| Информация профиля | 28 байт                                 |
| Статистика игр     | 231 байт (21 байт на 1 игру)            |
| Сумма              | 11.259 KB                               |

- Информация профиля: имя (10 символов, 20 байт) + краткое описание (4 символа, 8 байт)
- Статистика игры: идентификатор игры (4 байта) + кол-во часов (4 байта) + последний запуск (13 байт)
- Согласно [^7] в среднем у пользователя 11 игр. Отсюда получаем 21 * 11 = 231 байт

Игра
| Данные                  | Средний размер                |
|-------------------------|-------------------------------|
| Шапка                   | 44 KB                         |
| Скриншот                | 3.1 MB (389 KB на 1 скриншот) |
| Информация              | 4 KB                          |
| Файлы игры              | 20 GB                         |
| Сумма                   | 20.003148 GB                  |

- Было проанализировано 1000 случайных игр из магазина Steam
- В среднем у игры 8 скриншотов. Отсюда получаем 8 * 389 KB = 3.1 MB

Игровой предмет
| Данные             | Средний размер      |
|--------------------|---------------------|
| Идентификатор игры | 4 байта             |
| Картинка           | 38 KB               |
| Название           | 40 байт             |
| Описание           | 238 байт            |
| Сумма              | 38.282 KB           |

- Каждый символ весит 2 байта.

#### Среднее количество действий пользователя
| Действие                                             | Среднее число в день |
|------------------------------------------------------|----------------------|
| Регистрация/Аутентификация                           | 0.03                 |
| Просмотр игры                                        | 1.72                 |
| Покупка игры                                         | 0.005                |
| Скачивание игры                                      | 1.57                 |
| Совершение торгового обмена                          | 0.029                |
| Выставление предмета на продажу на торговой площадке | 0.0007               |
| Просмотр предмета на торговой площадке               | 0.007                |
| Покупка предмета на торговой площадке                | 0.00035              |
| Просмотр профиля                                     | 0.295                |
| Обновление профиля                                   | 0.03                 |
| Просмотр предметов                                   | 0.18                 |
| Отзыв об игре                                        | 0.00017              |

- Пользователь авторизуется в Steam в среднем раз в месяц. Тогда в день: 1 / 30 = 0.03
- Продано игр за год: 132М [^5] => За день: 132M / 365 = 361643 => один пользователь в среднем за день покупает: 361643 / 69M = 0.005
- Расчитаем число просмотров игры:
  - Согласно [^9] средняя конверсия: от 2 до 4%. Возьмем среднее: 3%. То есть для одной покупки необходимо: 1 / 0.03 = 33 посещения.
  - Предположим, что пользователь просматривает в среднем 10 страниц с играми. Тогда: 33 * 10 = 330 посещений.
  - Тогда общее число просмотров в день: 361643 * 330 = 119М
  - Тогда на одного пользователя: 119M / 69M = 1.72
- Учитывая что в среднем у пользователя 11 игр [^7] и предположив, что игры обновляются раз в неделю, то в день на 1 пользователя получим: 11 / 7 = 1.57
- Созданных торговых предложений за месяц: 58M [^4] => За день 58M / 30 = 2M => один пользователь в среднем создает торговых обменов: 2M / 69M = 0.029
- За период 1 января 2024 - 1 января 2025 согласно [^8] выставлялось 18.9М предметов => за день: 18.9M / 365 = 51780 => один пользователь в среднем выставляет на продажу: 0.0007
- За период 1 января 2024 - 1 января 2025 согласно [^8] в среднем было 172М посещений => за день: 172М / 365 = 471232 => один пользователь в среднем смотрит предметы: 0.007
- Зная метрику просмотров предмета на торговой площадке и метрику выставления предмета на продажу на торговой площадке, оценим метирку покупок. Предположим, что конверсия 5% (т.е. 1 из 20 предметов покупают). Тогда: 0.007 / 20 = 0.00035
- Чтобы обновить профиль, его надо открыть. Также следует учитывать что перед совершением обмена также будет смотреться профиль пользователя. Предположим, что каждое такое действие порождает в среднем 5 просмотров профилей. Тогда получим: (0.03 + 0.029) * 5 = 0.295
- Пользователь обновляет данные профиля в среднем раз в месяц. Тогда в день: 1 / 30 = 0.03
- Чтобы выставить предмет на продажу или совершить обмен, необходимо посмотреть инвентарь с предметами. Предположим что каждое такое действие порождает в среднем 5 просмотров инвентаря. Тогда получим: (0.029 + 0.007) * 5 = 0.18
- Согласно [^12] на 1 отзыв приходится ~30 продаж. Тогда зная метрику покупки игры получим: 0.005 / 30 = 0.00017

### Технические метрики
#### Размер хранения
| Тип данных      | Размер для одного | Количество | Размер для всех |
|-----------------|-------------------|------------|-----------------|
| Пользователь    | 11.259 KB         | 982М       | 11 TB           |
| Игра            | 20.003148 GB      | 114662     | 2.3 PB          |
| Игровой предмет | 38.282 KB         | 28M        | 1.0719 TB       |

- Согласно [^10] на момент 2020 года в Steam было зарегистрировано 667М аккаунтов. Согласно [^7] в 2017 году прирост пользователей был 63М. Тогда к 2025 получим: 667М + 63М * 5 = 982М.
  - Тогда: 11.259 KB * 982M = 11 TB
- Согласно [^6] в Steam на данный момент 114662 игр. Тогда: 20.003148 GB * 114662 = 2.3 PB
- Согласно [^8] в Steam на торговой площадке выставлено на продажу 28М игровых предметов. Тогда: 38.282 KB * 28M = 1.0719 TB

#### Сетевой трафик
RPS
- Для расчета воспользуемся таблицей с действиями пользователя и формула: (количество запросов в день от одного пользователя * DAU) / 86400
- Пиковый RPS возьмем в 3 раза выше среднего (согласно [^11]). В нашем сервисе пользователи расположены в разных часовых поясах, потому пиковая нагрузка будет не настолько резко большой.

| Действие                                             | RPS                | RPS в пике        |
|------------------------------------------------------|--------------------|-------------------|
| Регистрация/Аутентификация                           | 24                 | 48                |
| Просмотр игры                                        | 1374               | 2748              |
| Покупка игры                                         | 4                  | 8                 |
| Скачивание игры                                      | 1254               | 2508              |
| Совершение торгового обмена                          | 23.16              | 46.32             |
| Выставление предмета на продажу на торговой площадке | 0.55               | 1.1               |
| Просмотр предмета на торговой площадке               | 5.6                | 11.2              |
| Покупка предмета на торговой площадке                | 0.28               | 0.56              |
| Просмотр профиля                                     | 235.6              | 471.2             |
| Обновление профиля                                   | 24                 | 48                |
| Просмотр предметов                                   | 144                | 288               |
| Отзыв об игре                                        | 0.135              | 0.27              |

Общая нагрузка
- Формула для средней нагрузки: трафик * RPS
- Пиковую нагрузку возьмем в 2 раза выше средней

| Действие                                             | Трафик на действие (request + response) | Средняя нагрузка (Гбит/с) | Пиковая нагрузка (Гбит/с) |
|------------------------------------------------------|-----------------------------------------|---------------------------|---------------------------|
| Аутентификация                                       | 1 KB (888 байт + 174 байт)              | 0.000192                  | 0.000384                  |
| Просмотр игры                                        | 5.808 MB (2.66 KB + 3.148 MB)           | 63.8415                   | 127.683                   |
| Покупка игры                                         | 449 байт (286 байт + 163 байт)          | 0.000014                  | 0.000028                  |
| Скачивание игры                                      | 20 GB                                   | 200640                    | 401280                    |
| Совершение торгового обмена                          | 2.719 KB (2.61 KB + 109 байт)           | 0.0005                    | 0.001                     |
| Выставление предмета на продажу на торговой площадке | 2.256 KB (2.15 KB + 106 байт)           | 0.00001                   | 0.00002                   |
| Просмотр предмета на торговой площадке               | 42.11 KB (2.11 KB + 40 KB)              | 0.0019                    | 0.0038                    |
| Покупка предмета на торговой площадке                | 2.24 KB (2.23 KB + 151 байт)            | 0.000005                  | 0.00001                   |
| Просмотр профиля                                     | 13.37 KB (2.11 KB + 11.259 KB)          | 0.0252                    | 0.0504                    |
| Обновление профиля                                   | 4.4 KB (4.36 KB + 45 байт)              | 0.0008                    | 0.0016                    |
| Просмотр предметов                                   | 0.96 MB (2.11 KB + 38.282 KB * 25)      | 1.1059                    | 2.2118                    |
| Отзыв об игре                                        | 2.22 KB (2.21 KB + 33 байт)             | 0.0000024                 | 0.0000048                 |

- На одной странице с предметами 25 игровых предметов

## 3. Глобальная балансировка нагрузки
### Разбиение по доменам
В рамках нашего MVP будем использовать поддомены:
- game.steam.com - для скачивания игр
- community.steam.com - для взаимодействия с системами комьюнити (обмен/продажа предметов, профили, покупка игр, ...)

### Расположение ДЦ
На основе информации об использовании трафика [^11]:  
<img width="616" height="556" alt="image" src="https://github.com/user-attachments/assets/a618bda7-cd2a-40c7-8e1c-efd9e0cb1b6b" />  
а также карт [^11]:  
<img width="908" height="454" alt="image" src="https://github.com/user-attachments/assets/e760ddfc-00cd-42c8-80a9-acbea9e55010" />  
<img width="907" height="461" alt="image" src="https://github.com/user-attachments/assets/7e41bfb4-fd2f-4179-8ad0-5bbe6187b9ea" />  
расположим ДЦ следующим образом (регионы расположены от наиболее нагруженных к менее нагруженным).  
  
Скачивание игр является несложной операцией, датацентры выберем следующим образом:
- Азия: Токио (Япония), Пекин (Китай)
- Европа: Франкфурт (Германия)
- Северная Америка: Сан Хосе (Калифорния)
  
Для прочего функционала:
- Азия: Шанхай, Пекин (Китай), Токио (Япония)
- Европа: Франкфурт (Германия), Варшава (Польща)
- Северная Америка: Сан Хосе (Калифорния)

Карта расположенных ДЦ:
todo

### Расчет распределения запросов
Согласно [^11], общий трафик:
| Регион           | Использовано трафика всего (Tbps) |
|------------------|-----------------------------------|
| Азия             | 13.6                              |
| Европа           | 7.4                               |
| Северная Америка | 2.2                               |
| Ближний Восток   | 0.8                               |
| Океания          | 0.778                             |
| Южная Америка    | 0.446                             |

Пусть Ближний Восток будет равномерно распределятся между европейским и азиатским регионами, Океания будет использовать азиатский регион, а Южная Америка северо-американский регион. Тогда получим:
| Регион           | Использовано трафика всего (Tbps) |
|------------------|-----------------------------------|
| Азия             | 14.778                            |
| Европа           | 7.8                               |
| Северная Америка | 2.65                              |

Скачивание игр занимает большую часть трафика (~98%), согласно посчитанной ранее нагрузке.  
Тогда согласно [^11], а также выбранным ранее датацентрам для скачивания:
| Регион           | Использовано трафика (Tbps)       | Число датацентров | Трафик на 1 датацентр (Tbps) |
|------------------|-----------------------------------|-------------------|------------------------------|
| Азия             | 14.482                            | 2                 | 7.24                         |
| Европа           | 7.644                             | 1                 | 7.644                        |
| Северная Америка | 2.597                             | 1                 | 2.597                        |

Для остального трафика:
| Регион           | Использовано трафика (Tbps)       | Число датацентров | Трафик на 1 датацентр (Tbps) |
|------------------|-----------------------------------|-------------------|------------------------------|
| Азия             | 0.29                              | 3                 | 0.096                        |
| Европа           | 0.156                             | 2                 | 0.078                        |
| Северная Америка | 0.05194                           | 1                 | 0.05                         |

Переводя в процентное соотношение регионы по формуле: (трафик региона / общий трафик) * 100%:
| Регион           | Процентная доля трафика     |
|------------------|-----------------------------|
| Азия             | 58.565                      |
| Европа           | 30.9                        |
| Северная Америка | 10.49                       |

Посчитаем RPS считать по формуле: (RPS на действие) * (% трафика региона)
| Действие                                             | Азия    | Европа | Северная Америка |
|------------------------------------------------------|---------|--------|------------------|
| Скачивание игры                                      | 734.49  | 387.67 | 131.54           |
| Остальной функционал                                 | 1074.52 | 567.48 | 192.48           |

Посчитаем RPS по датацентрам: (RPS из региона) / кол-во датацентров  
Для скачивания игр:  
| Регион           | RPS    | Число датацентров | RPS на 1 датацентр |
|------------------|--------|-------------------|--------------------|
| Азия             | 734.49 | 2                 | 367.245            |
| Европа           | 387.67 | 1                 | 387.67             |
| Северная Америка | 131.54 | 1                 | 131.54             |

Для прочего функционала:  
| Регион           | RPS     | Число датацентров | RPS на 1 датацентр |
|------------------|---------|-------------------|--------------------|
| Азия             | 1074.52 | 3                 | 358.17             |
| Европа           | 567.48  | 2                 | 283.74             |
| Северная Америка | 192.48  | 1                 | 192.48             |

### Схема DNS балансировки
Будем использовать Geo-based DNS, т.к. сервисом пользуются по всему миру.

### Схема Anycast балансировки
Дополнительно к DNS балансировке в высоконагруженных регионах (Азия, Северная Америка, Европа) можно воспользоваться BGP Anycast для более точного выбора датацентра.

## 4. Локальная балансировка нагрузки

### Схема балансировки нагрузки

### Расчёт количества балансировщиков

## Список использованных источников
[^1]: [Steamworks ](https://partner.steamgames.com/)
[^2]: [Steam Statistics 2025: Users & Revenue Data](https://www.demandsage.com/steam-statistics/#:~:text=Steam%20has%20132%20million%20monthly%2Ctime%20high%20of%20%2410.8%20billion)
[^3]: [Steam Users by Country 2025](https://worldpopulationreview.com/country-rankings/steam-users-by-country)
[^4]: [Trade.TF - Trade Volume](https://www.trade.tf/volume)
[^5]: [Steam Market Data | Video Game Insights](https://app.sensortower.com/vgi/steam-market-data)
[^6]: [Steam Game Release Summary by Year · SteamDB](https://steamdb.info/stats/releases/)
[^7]: [Steam in 2017](https://media.gdcvault.com/gdc2018/presentations/Steam_in_2017.pdf)
[^8]: [Steam | Market Overview](https://csgoskins.gg/markets/steam)
[^9]: [Где мои деньги, чувак: о чем молчит Steam](https://habr.com/ru/articles/423215/)
[^10]: [Scanning all possible Steam IDs, and what we have found](https://steamdb.info/blog/scanning-all-steam-ids/)
[^11]: [Steam: Game and Player Statistics](https://store.steampowered.com/stats/content/)
[^12]: [How to Estimate Steam Video Game Sales?](https://app.sensortower.com/vgi/insights/article/how-to-estimate-steam-video-game-sales)
